<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi Sim 0.2</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #212121);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --btn-color: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #323232);
            --hint-color: var(--tg-theme-hint-color, #aaaaaa);
            --green: #2ecc71;
            --red: #e74c3c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            user-select: none;
            overflow: hidden; /* –ß—Ç–æ–±—ã –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª–æ—Å—å */
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--secondary-bg);
        }
        .resource {
            font-size: 16px;
            font-weight: bold;
        }
        .fuel-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* --- –ò–ì–†–û–í–ê–Ø –ó–û–ù–ê --- */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .car-display {
            font-size: 100px;
            transition: transform 0.1s;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –º–∞—à–∏–Ω—É */
        .car-display:active {
            transform: scale(0.9);
        }

        .tap-hint {
            font-size: 14px;
            color: var(--hint-color);
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: var(--secondary-bg);
            border-radius: 4px;
            margin-top: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--btn-color);
            transition: width 0.1s linear;
        }

        /* --- –ú–ï–ù–Æ (–í–ö–õ–ê–î–ö–ò) --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-top: auto; /* –ü—Ä–∏–∂–∞—Ç—å –∫ –Ω–∏–∑—É */
            padding-top: 15px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: var(--secondary-bg);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            color: var(--text-color);
            font-weight: 500;
        }
        .tab-btn.active {
            background: var(--btn-color);
            color: var(--btn-text);
        }

        /* --- –≠–ö–†–ê–ù –ú–ê–ì–ê–ó–ò–ù–ê --- */
        #shop-screen {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding-top: 20px;
        }
        .shop-item {
            background: var(--secondary-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shop-info h3 { margin: 0 0 5px 0; font-size: 16px; }
        .shop-info p { margin: 0; font-size: 12px; color: var(--hint-color); }
        
        .buy-btn {
            background: var(--btn-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        .buy-btn:disabled { opacity: 0.5; }
        .equipped-badge {
            background: var(--green);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        /* --- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø --- */
        .main-btn {
            width: 100%;
            padding: 16px;
            background: var(--btn-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
        }
        .main-btn:disabled { background: var(--secondary-bg); color: #777; }
        
        .refuel-btn {
            font-size: 12px;
            padding: 4px 8px;
            background: var(--secondary-bg);
            border-radius: 4px;
            margin-left: 5px;
        }

    </style>
</head>
<body>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="top-bar">
        <div class="resource">üí∞ <span id="balance">0</span></div>
        <div class="fuel-container">
            <span class="resource">‚õΩ <span id="fuel">10</span>/10</span>
            <div class="refuel-btn" onclick="buyFuel()">+1 (5üí∞)</div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –ò–ì–†–´ -->
    <div id="game-screen" class="game-area">
        <div id="current-car" class="car-display" onclick="tapCar()">üöñ</div>
        <div id="status-text" style="margin-top: 10px; color: #888;">–°–≤–æ–±–æ–¥–µ–Ω</div>
        <div id="tap-hint" class="tap-hint">–¢–∞–ø–∞–π, —á—Ç–æ–±—ã –µ—Ö–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ! üî•</div>
        
        <div class="progress-container">
            <div id="progress" class="progress-bar"></div>
        </div>

        <button id="drive-btn" class="main-btn" onclick="startOrder()">üöè –í–∑—è—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <!-- –≠–ö–†–ê–ù –ú–ê–ì–ê–ó–ò–ù–ê -->
    <div id="shop-screen">
        <!-- –°—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç –º–∞—à–∏–Ω—ã -->
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('game')">üöñ –†–∞–±–æ—Ç–∞</div>
        <div class="tab-btn" onclick="switchTab('shop')">üè™ –ì–∞—Ä–∞–∂</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—à–∏–Ω
        const carsDB = [
            { id: 0, name: "–î–µ–¥–æ–≤—Å–∫–∞—è –õ–∞—Å—Ç–æ—á–∫–∞", emoji: "üöô", price: 0, reward: 10, speed: 1.0 },
            { id: 1, name: "–≠–∫–æ–Ω–æ–º –¢–∞–∫—Å–∏", emoji: "üöñ", price: 500, reward: 20, speed: 1.2 },
            { id: 2, name: "–ë–∏–∑–Ω–µ—Å –°–µ–¥–∞–Ω", emoji: "üöò", price: 2000, reward: 50, speed: 1.5 },
            { id: 3, name: "–°–ø–æ—Ä—Ç–∫–∞—Ä", emoji: "üèéÔ∏è", price: 10000, reward: 150, speed: 2.0 },
            { id: 4, name: "–í–µ—Ä—Ç–æ–ª–µ—Ç (VIP)", emoji: "üöÅ", price: 50000, reward: 500, speed: 3.0 }
        ];

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let state = {
            balance: 0,
            fuel: 10,
            maxFuel: 10,
            ownedCars: [0], // ID –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –º–∞—à–∏–Ω
            currentCarId: 0
        };

        let isDriving = false;
        let driveInterval = null;
        let currentProgress = 0;
        let speedMultiplier = 1; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–∞—Ö

        // –ó–∞–≥—Ä—É–∑–∫–∞
        const saved = localStorage.getItem('taxiSimv02');
        if (saved) state = JSON.parse(saved);

        // UI –≠–ª–µ–º–µ–Ω—Ç—ã
        const els = {
            balance: document.getElementById('balance'),
            fuel: document.getElementById('fuel'),
            car: document.getElementById('current-car'),
            status: document.getElementById('status-text'),
            progress: document.getElementById('progress'),
            driveBtn: document.getElementById('drive-btn'),
            shop: document.getElementById('shop-screen'),
            game: document.getElementById('game-screen'),
            hint: document.getElementById('tap-hint')
        };

        function save() {
            localStorage.setItem('taxiSimv02', JSON.stringify(state));
        }

        function updateUI() {
            els.balance.innerText = state.balance;
            els.fuel.innerText = state.fuel;
            
            const currentCar = carsDB.find(c => c.id === state.currentCarId);
            els.car.innerText = currentCar.emoji;
            
            els.driveBtn.disabled = isDriving || state.fuel <= 0;
            if (state.fuel <= 0 && !isDriving) {
                els.driveBtn.innerText = "‚õΩ –ù–µ—Ç –±–µ–Ω–∑–∏–Ω–∞";
            } else if (isDriving) {
                els.driveBtn.innerText = "–í –ø—É—Ç–∏...";
            } else {
                els.driveBtn.innerText = "üöè –í–∑—è—Ç—å –∑–∞–∫–∞–∑";
            }

            renderShop();
            save();
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---

        function startOrder() {
            if (isDriving || state.fuel <= 0) return;

            state.fuel -= 1;
            isDriving = true;
            currentProgress = 0;
            speedMultiplier = 1;
            
            els.status.innerText = "–í–µ–∑–µ–º –∫–ª–∏–µ–Ω—Ç–∞...";
            els.hint.style.opacity = 1;
            tg.HapticFeedback.impactOccurred('medium');

            const currentCar = carsDB.find(c => c.id === state.currentCarId);
            
            // –ë–∞–∑–æ–≤—ã–π —à–∞–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—à–∏–Ω—ã)
            const baseStep = 0.5 * currentCar.speed; 

            driveInterval = setInterval(() => {
                // –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                currentProgress += baseStep * speedMultiplier;
                
                // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è –∫–ª–∏–∫–æ–≤ (–∏–Ω–µ—Ä—Ü–∏—è)
                if(speedMultiplier > 1) speedMultiplier -= 0.05;
                if(speedMultiplier < 1) speedMultiplier = 1;

                els.progress.style.width = Math.min(currentProgress, 100) + '%';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä—è—Å–∫–∏ –º–∞—à–∏–Ω—ã –ø—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
                if(speedMultiplier > 1.5) {
                    els.car.style.transform = `rotate(${Math.random()*4-2}deg) scale(1.1)`;
                } else {
                    els.car.style.transform = `rotate(0deg) scale(1)`;
                }

                if (currentProgress >= 100) {
                    finishOrder(currentCar);
                }
            }, 30); // 30ms —Ç–∏–∫
            
            updateUI();
        }

        function finishOrder(car) {
            clearInterval(driveInterval);
            isDriving = false;
            els.hint.style.opacity = 0;
            els.car.style.transform = `scale(1)`;
            els.status.innerText = "–ü—Ä–∏–µ—Ö–∞–ª–∏!";
            
            state.balance += car.reward;
            tg.HapticFeedback.notificationOccurred('success');
            
            setTimeout(() => {
                els.progress.style.width = '0%';
                els.status.innerText = "–°–≤–æ–±–æ–¥–µ–Ω";
                updateUI();
            }, 500);
            
            updateUI();
        }

        // –ö–ª–∏–∫ –ø–æ –º–∞—à–∏–Ω–µ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ)
        function tapCar() {
            if (!isDriving) return;
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏
            speedMultiplier += 0.5;
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
            if(speedMultiplier > 5) speedMultiplier = 5;

            tg.HapticFeedback.impactOccurred('light');
        }

        // –ü–æ–∫—É–ø–∫–∞ –±–µ–Ω–∑–∏–Ω–∞
        function buyFuel() {
            if (state.balance >= 5 && state.fuel < state.maxFuel) {
                state.balance -= 5;
                state.fuel += 1;
                tg.HapticFeedback.selectionChanged();
                updateUI();
            } else if (state.fuel >= state.maxFuel) {
                tg.showAlert("–ë–∞–∫ –ø–æ–ª–æ–Ω!");
            } else {
                tg.showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥ (–Ω—É–∂–Ω–æ 5üí∞)");
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê ---

        function renderShop() {
            els.shop.innerHTML = "";
            
            carsDB.forEach(car => {
                const isOwned = state.ownedCars.includes(car.id);
                const isEquipped = state.currentCarId === car.id;
                
                const div = document.createElement('div');
                div.className = 'shop-item';
                
                let btnHTML = '';
                if (isEquipped) {
                    btnHTML = `<div class="equipped-badge">–í—ã–±—Ä–∞–Ω–æ</div>`;
                } else if (isOwned) {
                    btnHTML = `<button class="buy-btn" onclick="equipCar(${car.id})">–í—ã–±—Ä–∞—Ç—å</button>`;
                } else {
                    const canBuy = state.balance >= car.price;
                    btnHTML = `<button class="buy-btn" ${!canBuy ? 'disabled' : ''} onclick="buyCar(${car.id})">–ö—É–ø–∏—Ç—å ${car.price}üí∞</button>`;
                }

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="font-size:30px;">${car.emoji}</div>
                        <div class="shop-info">
                            <h3>${car.name}</h3>
                            <p>–î–æ—Ö–æ–¥: ${car.reward}üí∞ | –°–∫–æ—Ä–æ—Å—Ç—å: x${car.speed}</p>
                        </div>
                    </div>
                    ${btnHTML}
                `;
                els.shop.appendChild(div);
            });
        }

        function buyCar(id) {
            const car = carsDB.find(c => c.id === id);
            if (state.balance >= car.price) {
                state.balance -= car.price;
                state.ownedCars.push(id);
                tg.HapticFeedback.notificationOccurred('success');
                equipCar(id); // –°—Ä–∞–∑—É —Å–∞–¥–∏–º—Å—è –≤ –Ω–æ–≤—É—é
            }
        }

        function equipCar(id) {
            state.currentCarId = id;
            updateUI();
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (tabName === 'game') {
                els.game.style.display = 'flex';
                els.shop.style.display = 'none';
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else {
                els.game.style.display = 'none';
                els.shop.style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        };

        // –°—Ç–∞—Ä—Ç
        updateUI();

    </script>
</body>
</html>