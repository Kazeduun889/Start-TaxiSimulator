<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi Sim 0.4</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --btn-color: #3390ec;
            --secondary-bg: #2b2b2b;
            --road-color: #333;
            --line-color: #555;
            --green: #2ecc71;
            --yellow: #f1c40f;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0;
            padding: 0; /* –£–±—Ä–∞–ª–∏ –ø–∞–¥–¥–∏–Ω–≥–∏ –¥–ª—è –¥–æ—Ä–æ–≥–∏ */
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
            overflow: hidden;
        }

        /* --- UI –ü–ê–ù–ï–õ–ò --- */
        .ui-padding { padding: 15px; }

        .top-bar {
            display: flex;
            justify-content: space-between;
            background: var(--secondary-bg);
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .stat-group { display: flex; flex-direction: column; }
        .stat-val { font-weight: bold; font-size: 16px; }
        .stat-label { font-size: 11px; color: #888; }

        /* --- –î–û–†–û–ì–ê –ò –ú–ê–®–ò–ù–ê --- */
        .game-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--road-color);
            overflow: hidden;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–æ—Ä–æ–≥–∏ */
        .road-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                180deg,
                transparent 0,
                transparent 50px,
                var(--line-color) 50px,
                var(--line-color) 100px
            );
            /* –°–∫–æ—Ä–æ—Å—Ç—å –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS */
            animation: moveRoad 1s linear infinite;
            animation-play-state: paused; 
            opacity: 0.3;
        }

        @keyframes moveRoad {
            from { background-position: 0 0; }
            to { background-position: 0 100px; }
        }

        .car-container {
            position: relative;
            z-index: 5;
            margin-bottom: 20px;
        }
        
        .car-emoji {
            font-size: 90px;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            transition: transform 0.1s;
        }

        .click-effect {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 20px;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 0 0 5px black;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        /* --- –ò–ù–¢–ï–†–§–ï–ô–° –í –ü–£–¢–ò --- */
        .progress-wrapper {
            width: 80%;
            z-index: 10;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        .progress-bar {
            height: 10px;
            background: #444;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--yellow);
        }
        .speed-text { text-align: center; font-family: monospace; font-size: 14px; }

        .hint-text {
            position: absolute;
            bottom: 100px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            z-index: 5;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% {opacity:0.3} 50% {opacity:0.8} 100% {opacity:0.3} }

        /* --- –ö–ù–û–ü–ö–ò --- */
        .controls {
            padding: 20px;
            background: var(--secondary-bg);
            border-top: 1px solid #333;
            z-index: 10;
        }

        .main-btn {
            width: 100%;
            padding: 18px;
            background: var(--btn-color);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #2368a8;
        }
        .main-btn:active { transform: translateY(4px); box-shadow: none; }
        .main-btn:disabled { background: #444; color: #888; box-shadow: none; transform: none; }

        /* --- –ú–ï–ù–Æ –¢–ê–ë–´ --- */
        .tabs {
            display: flex;
            background: #111;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        .tab.active { color: white; background: var(--secondary-bg); border-top: 2px solid var(--btn-color); }

        /* --- –ú–ê–ì–ê–ó–ò–ù --- */
        #shop-view { display: none; padding: 20px; overflow-y: auto; height: 100%; }
        .shop-card {
            background: #333;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shop-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: var(--btn-color);
            color: white;
            font-weight: bold;
        }
        .shop-btn:disabled { opacity: 0.5; background: #555; }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="stat-group">
            <span class="stat-val" id="balance">0 üí∞</span>
            <span class="stat-label">–ë–∞–ª–∞–Ω—Å</span>
        </div>
        <div class="stat-group" style="align-items: center;">
            <span class="stat-val" style="color:var(--green)">LVL <span id="lvl">1</span></span>
            <span class="stat-label"><span id="xp">0</span> XP</span>
        </div>
        <div class="stat-group" style="align-items: flex-end;">
            <span class="stat-val">‚õΩ <span id="fuel">10</span>/<span id="max-fuel">10</span></span>
            <span class="stat-label" id="timer">–ü–æ–ª–Ω—ã–π</span>
        </div>
    </div>

    <!-- –ò–ì–†–û–í–ê–Ø –û–ë–õ–ê–°–¢–¨ -->
    <div id="game-view" class="game-area" onclick="tapCar(event)">
        <div class="road-lines" id="road"></div>

        <div class="hint-text" id="hint">–ù–∞–∂–º–∏ "–í–∑—è—Ç—å –∑–∞–∫–∞–∑"</div>

        <div class="car-container">
            <div id="car" class="car-emoji">üöñ</div>
        </div>

        <div class="progress-wrapper" id="progress-ui" style="opacity: 0;">
            <div class="progress-bar"><div class="progress-fill" id="fill"></div></div>
            <div class="speed-text"><span id="speed-val">0</span> km/h</div>
        </div>
    </div>

    <!-- –ú–ê–ì–ê–ó–ò–ù -->
    <div id="shop-view"></div>

    <div class="controls">
        <button id="main-btn" class="main-btn" onclick="actionBtn()">–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="setTab('game')">–†–£–õ–¨</div>
        <div class="tab" onclick="setTab('shop')">–ì–ê–†–ê–ñ</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const cars = [
            { id: 0, name: "–†–∞–∑–±–∏—Ç–∞—è –õ–∞–¥–∞", emoji: "üöô", price: 0, reward: 20, acc: 0.5 },
            { id: 1, name: "–°–æ–ª—è—Ä–∏—Å", emoji: "üöñ", price: 500, reward: 45, acc: 0.7 },
            { id: 2, name: "–ú–µ—Ä—Å E-—à–∫–∞", emoji: "üöò", price: 2500, reward: 120, acc: 1.0 },
            { id: 3, name: "–§–µ—Ä—Ä–∞—Ä–∏", emoji: "üèéÔ∏è", price: 10000, reward: 350, acc: 1.5 },
            { id: 4, name: "–ù–õ–û", emoji: "üõ∏", price: 50000, reward: 1000, acc: 3.0 }
        ];

        let state = {
            money: 0,
            xp: 0,
            level: 1,
            fuel: 10,
            lastRefill: Date.now(),
            owned: [0],
            selected: 0
        };

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–ª–∞–Ω—Å–∞ (—Å–ª–æ–∂–Ω–æ—Å—Ç—å)
        const REGEN_TIME = 60000;
        const LEVEL_XP_STEP = 100; // XP –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
        const TRIP_DISTANCE = 1000; // –£—Å–ª–æ–≤–Ω—ã–µ –º–µ—Ç—Ä—ã –ø—É—Ç–∏

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        let isDriving = false;
        let distanceCovered = 0;
        let speed = 0;
        let driveLoop = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞
        if(localStorage.getItem('taxi_v4')) {
            state = JSON.parse(localStorage.getItem('taxi_v4'));
            // –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–≥–µ–Ω
            let passed = Date.now() - state.lastRefill;
            let amount = Math.floor(passed / REGEN_TIME);
            let maxFuel = 9 + state.level; // 10 –Ω–∞ 1 —É—Ä–æ–≤–Ω–µ, 11 –Ω–∞ 2 –∏ —Ç.–¥.
            if(amount > 0 && state.fuel < maxFuel) {
                state.fuel = Math.min(maxFuel, state.fuel + amount);
                state.lastRefill = Date.now();
            }
        }

        // --- –õ–û–ì–ò–ö–ê ---

        function getMaxFuel() { return 9 + state.level; }

        function updateUI() {
            document.getElementById('balance').innerText = `${state.money} üí∞`;
            document.getElementById('lvl').innerText = state.level;
            document.getElementById('xp').innerText = `${state.xp}/${state.level * LEVEL_XP_STEP}`;
            document.getElementById('fuel').innerText = state.fuel;
            document.getElementById('max-fuel').innerText = getMaxFuel();
            
            let car = cars.find(c => c.id === state.selected);
            document.getElementById('car').innerText = car.emoji;

            const btn = document.getElementById('main-btn');
            if(isDriving) {
                btn.innerText = "–í –ü–£–¢–ò...";
                btn.disabled = true;
            } else {
                if(state.fuel > 0) {
                    btn.innerText = "–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó (-1‚õΩ)";
                    btn.disabled = false;
                } else {
                    btn.innerText = "–ù–ï–¢ –ë–ï–ù–ó–ò–ù–ê";
                    btn.disabled = true;
                }
            }
            localStorage.setItem('taxi_v4', JSON.stringify(state));
        }

        // –¢–∞–π–º–µ—Ä –±–µ–Ω–∑–∏–Ω–∞
        setInterval(() => {
            if(state.fuel < getMaxFuel()) {
                let left = REGEN_TIME - (Date.now() - state.lastRefill);
                if(left <= 0) {
                    state.fuel++;
                    state.lastRefill = Date.now();
                    updateUI();
                } else {
                    document.getElementById('timer').innerText = Math.ceil(left/1000) + '—Å';
                }
            } else {
                document.getElementById('timer').innerText = "–ü–æ–ª–Ω—ã–π";
                state.lastRefill = Date.now();
            }
        }, 1000);

        function actionBtn() {
            if(state.fuel <= 0) {
                // –ï—Å–ª–∏ –Ω–µ—Ç –±–µ–Ω–∑–∏–Ω–∞ - –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å
                if(state.money >= 10) {
                    state.money -= 10;
                    state.fuel++;
                    updateUI();
                    tg.showAlert("–ó–∞–ø—Ä–∞–≤–∏–ª–∏ 1 –ª–∏—Ç—Ä!");
                } else {
                    tg.showAlert("–ë–µ–Ω–∑–∏–Ω –∫–æ–Ω—á–∏–ª—Å—è! –ñ–¥–∏ –∏–ª–∏ –∫–æ–ø–∏ 10üí∞");
                }
                return;
            }
            startDrive();
        }

        function startDrive() {
            state.fuel--;
            state.lastRefill = Date.now(); // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ —á—Ç–æ–±—ã –Ω–µ —á–∏—Ç–µ—Ä–∏–ª–∏
            isDriving = true;
            distanceCovered = 0;
            speed = 0;

            document.getElementById('progress-ui').style.opacity = 1;
            document.getElementById('hint').innerText = "–¢–∞–ø–∞–π —Å–∏–ª—å–Ω–æ, –¥–æ—Ä–æ–≥–∞ –¥–ª–∏–Ω–Ω–∞—è!";
            document.getElementById('road').style.animationPlayState = 'running';
            
            updateUI();

            const carStats = cars.find(c => c.id === state.selected);

            driveLoop = setInterval(() => {
                // –§–∏–∑–∏–∫–∞
                // 1. –°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (–º–∞—à–∏–Ω–∞ –±—ã—Å—Ç—Ä–æ —Ç–µ—Ä—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å —Å–∞–º–∞)
                speed *= 0.96; 
                
                // 2. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–ø–æ–ª–∑–µ—Ç)
                if(speed < 0.5) speed = 0.5;

                // 3. –ü—Ä–æ–≥—Ä–µ—Å—Å
                distanceCovered += speed;
                
                // –í–∏–∑—É–∞–ª
                let progressPct = (distanceCovered / TRIP_DISTANCE) * 100;
                document.getElementById('fill').style.width = Math.min(progressPct, 100) + '%';
                
                let displaySpeed = Math.floor(speed * 20); // –§–µ–π–∫–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∫–º/—á
                document.getElementById('speed-val').innerText = displaySpeed;

                // –ê–Ω–∏–º–∞—Ü–∏—è –¥–æ—Ä–æ–≥–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
                let animDuration = Math.max(0.1, 1 - (displaySpeed / 200));
                document.getElementById('road').style.animationDuration = `${animDuration}s`;

                // –¢—Ä—è—Å–∫–∞
                if(displaySpeed > 50) {
                    let shake = (Math.random() - 0.5) * 5;
                    document.getElementById('car').style.transform = `translateX(${shake}px) scale(1.05)`;
                } else {
                    document.getElementById('car').style.transform = `translateX(0) scale(1)`;
                }

                // –§–∏–Ω–∏—à
                if(distanceCovered >= TRIP_DISTANCE) {
                    finishDrive(carStats);
                }

            }, 50);
        }

        function tapCar(e) {
            if(!isDriving) return;

            const carStats = cars.find(c => c.id === state.selected);
            
            // –ë—É—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–∞—à–∏–Ω—ã
            // –ß–µ–º –≤—ã—à–µ —Å–∫–æ—Ä–æ—Å—Ç—å, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ —Ä–∞–∑–≥–æ–Ω—è—Ç—å—Å—è
            let boost = carStats.acc * 2;
            if(speed > 10) boost *= 0.5; 
            
            speed += boost;
            if(speed > 15 * carStats.acc) speed = 15 * carStats.acc; // –ú–∞–∫—Å–∏–º–∞–ª–∫–∞

            tg.HapticFeedback.impactOccurred('light');

            // –í—Å–ø–ª—ã–≤–∞—é—â–∞—è —Ü–∏—Ñ—Ä–∞
            showFloatText(e.clientX, e.clientY);
        }

        function showFloatText(x, y) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã), –±–µ—Ä–µ–º —Ü–µ–Ω—Ç—Ä
            if(!x) { x = window.innerWidth/2; y = window.innerHeight/2; }
            
            const el = document.createElement('div');
            el.className = 'click-effect';
            el.innerText = 'üí®'; // –ò–ª–∏ "+KM"
            el.style.left = (x - 10) + 'px';
            el.style.top = (y - 20) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function finishDrive(car) {
            clearInterval(driveLoop);
            isDriving = false;
            document.getElementById('road').style.animationPlayState = 'paused';
            document.getElementById('progress-ui').style.opacity = 0;
            document.getElementById('hint').innerText = "–ö–ª–∏–µ–Ω—Ç –¥–æ–≤–æ–ª–µ–Ω!";
            document.getElementById('car').style.transform = `scale(1)`;
            
            // –ù–∞–≥—Ä–∞–¥–∞
            state.money += car.reward;
            
            // –û–ø—ã—Ç
            let xpGain = 20;
            state.xp += xpGain;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è
            let needed = state.level * LEVEL_XP_STEP;
            if(state.xp >= needed) {
                state.xp -= needed;
                state.level++;
                tg.showAlert(`üéâ –£–†–û–í–ï–ù–¨ ${state.level}! –ë–∞–∫ —É–≤–µ–ª–∏—á–µ–Ω!`);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                tg.HapticFeedback.notificationOccurred('success');
            }

            updateUI();
        }

        // --- –ú–ê–ì–ê–ó–ò–ù –ò –¢–ê–ë–´ ---
        function renderShop() {
            const container = document.getElementById('shop-view');
            container.innerHTML = '';
            cars.forEach(car => {
                const el = document.createElement('div');
                el.className = 'shop-card';
                
                let btnTxt = '–ö—É–ø–∏—Ç—å';
                let dis = false;
                let onclick = `buy(${car.id})`;

                if(state.owned.includes(car.id)) {
                    if(state.selected === car.id) {
                        btnTxt = '–í—ã–±—Ä–∞–Ω–æ';
                        dis = true;
                    } else {
                        btnTxt = '–í—ã–±—Ä–∞—Ç—å';
                        onclick = `selectCar(${car.id})`;
                    }
                } else {
                    btnTxt = `${car.price}üí∞`;
                    if(state.money < car.price) dis = true;
                }

                el.innerHTML = `
                    <div>
                        <div style="font-size:24px">${car.emoji} <b>${car.name}</b></div>
                        <div style="color:#888; font-size:12px;">–£—Å–∫–æ—Ä–µ–Ω–∏–µ: x${car.acc} | –ù–∞–≥—Ä–∞–¥–∞: ${car.reward}</div>
                    </div>
                    <button class="shop-btn" ${dis ? 'disabled' : ''} onclick="${onclick}">${btnTxt}</button>
                `;
                container.appendChild(el);
            });
        }

        window.buy = (id) => {
            let car = cars.find(c => c.id === id);
            if(state.money >= car.price) {
                state.money -= car.price;
                state.owned.push(id);
                state.selected = id;
                renderShop();
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            }
        };

        window.selectCar = (id) => {
            state.selected = id;
            renderShop();
            updateUI();
        };

        window.setTab = (t) => {
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            if(t === 'game') {
                document.getElementById('game-view').style.display = 'flex';
                document.getElementById('shop-view').style.display = 'none';
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else {
                renderShop();
                document.getElementById('game-view').style.display = 'none';
                document.getElementById('shop-view').style.display = 'block';
                document.querySelectorAll('.tab')[1].classList.add('active');
            }
        };

        updateUI();

    </script>
</body>
</html>