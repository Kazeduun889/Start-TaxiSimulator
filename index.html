<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi Premium 0.5</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-grad: radial-gradient(circle at center, #2b2b2b 0%, #000000 100%);
            --card-bg: rgba(255, 255, 255, 0.08);
            --accent: #f1c40f; /* Taxi Yellow */
            --accent-glow: rgba(241, 196, 15, 0.4);
            --text-main: #ffffff;
            --text-sec: #888888;
            --danger: #e74c3c;
            --success: #2ecc71;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }

        body {
            background: var(--bg-grad);
            color: var(--text-main);
            font-family: var(--font);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            padding-top: 25px;
            z-index: 10;
        }

        .stat-badge {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .fuel-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--success);
        }
        .fuel-dot.low { background: var(--danger); box-shadow: 0 0 5px var(--danger); }

        /* --- –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ß–ê–°–¢–¨ (–ê–í–¢–û) --- */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .car-wrapper {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .car-emoji {
            font-size: 120px;
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6));
            z-index: 2;
            cursor: pointer;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ (–∫—Ä—É–≥–∏) */
        .speed-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--accent);
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s;
        }

        .speedometer {
            margin-top: 20px;
            text-align: center;
        }
        .speed-val {
            font-size: 42px;
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            text-shadow: 0 0 20px var(--accent-glow);
        }
        .speed-label {
            font-size: 12px;
            color: var(--text-sec);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* --- –ü–†–û–ì–†–ï–°–° –ë–ê–† --- */
        .progress-area {
            width: 85%;
            margin-bottom: 20px;
        }
        .progress-track {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent);
            transition: width 0.1s linear;
        }

        /* --- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø --- */
        .action-area {
            padding: 20px;
            padding-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(to top, #000 0%, transparent 100%);
        }

        .main-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 18px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(241, 196, 15, 0.3);
            transition: transform 0.1s, opacity 0.2s;
        }
        .main-btn:active { transform: scale(0.98); }
        .main-btn:disabled { background: #333; color: #666; box-shadow: none; }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        .nav {
            display: flex;
            background: #111;
            padding-bottom: env(safe-area-inset-bottom); /* –î–ª—è iPhone */
        }
        .nav-item {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: #555;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--accent);
            background: rgba(255,255,255,0.03);
        }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* --- –ú–ê–ì–ê–ó–ò–ù (–û–≤–µ—Ä–ª–µ–π) --- */
        #shop-screen {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 80px; /* Leave space for nav */
            background: var(--bg-grad);
            z-index: 20;
            padding: 20px;
            overflow-y: auto;
        }
        .shop-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; margin-top: 40px;}
        
        .car-card {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .buy-btn {
            background: #333;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
        }
        .buy-btn.active { background: var(--accent); color: black; }

        /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ --- */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
        
        /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç */
        .pop-text {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            animation: popUp 0.6s ease-out forwards;
        }
        @keyframes popUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.5); }
        }

    </style>
</head>
<body>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="header">
        <div class="stat-badge">
            <span id="balance">0</span> üí∞
        </div>
        <div class="stat-badge">
            <div id="fuel-dot" class="fuel-dot"></div>
            <span id="fuel">10</span>/10
            <span id="timer" style="font-size: 10px; color: #666; margin-left:5px"></span>
        </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–∞—è —Å—Ü–µ–Ω–∞ -->
    <div id="game-view" class="stage">
        <div class="car-wrapper floating" id="car-wrap" onclick="tapCar(event)">
            <div class="speed-ring" id="ring"></div>
            <div class="car-emoji" id="car-emoji">üöñ</div>
        </div>

        <div class="speedometer">
            <div class="speed-val"><span id="speed">0</span></div>
            <div class="speed-label">km/h</div>
        </div>

        <div style="flex:1"></div> <!-- –†–∞—Å–ø–æ—Ä–∫–∞ -->

        <div class="progress-area">
            <div class="progress-track">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div id="status" style="text-align: center; font-size: 13px; color: #666; margin-top: 8px;">
                –°–≤–æ–±–æ–¥–µ–Ω
            </div>
        </div>

        <div class="action-area">
            <button id="main-btn" class="main-btn" onclick="takeOrder()">–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó</button>
        </div>
    </div>

    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
    <div id="shop-screen">
        <div class="shop-header">–ì–∞—Ä–∞–∂</div>
        <div id="shop-list"></div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="nav">
        <div class="nav-item active" onclick="switchTab('game')">
            <span class="nav-icon">üöñ</span>–†–∞–±–æ—Ç–∞
        </div>
        <div class="nav-item" onclick="switchTab('shop')">
            <span class="nav-icon">üè™</span>–ì–∞—Ä–∞–∂
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const SAVE_KEY = 'taxi_universal_save'; // –ï–¥–∏–Ω—ã–π –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const REGEN_TIME = 60000; // 1 –º–∏–Ω—É—Ç–∞

        const carsDB = [
            { id: 0, name: "Start", emoji: "üöô", price: 0, reward: 20, power: 1.0 },
            { id: 1, name: "Sedan", emoji: "üöñ", price: 500, reward: 50, power: 1.3 },
            { id: 2, name: "Sport", emoji: "üèéÔ∏è", price: 2500, reward: 150, power: 1.8 },
            { id: 3, name: "Super", emoji: "üöÄ", price: 10000, reward: 500, power: 2.5 }
        ];

        // --- –°–û–°–¢–û–Ø–ù–ò–ï ---
        let state = {
            money: 0,
            fuel: 10,
            maxFuel: 10,
            lastRefill: Date.now(),
            owned: [0],
            selected: 0,
            level: 1
        };

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        let isDriving = false;
        let speed = 0;
        let progress = 0;
        let loop = null;

        // --- –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–ô ---
        function loadGame() {
            // 1. –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–π–≤
            const data = localStorage.getItem(SAVE_KEY);
            if (data) {
                state = { ...state, ...JSON.parse(data) };
            } 
            // 2. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, –∏—â–µ–º —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ (–º–∏–≥—Ä–∞—Ü–∏—è)
            else if (localStorage.getItem('taxi_v4')) {
                const old = JSON.parse(localStorage.getItem('taxi_v4'));
                state.money = old.money || 0;
                state.fuel = old.fuel || 10;
                state.owned = old.owned || [0];
                saveGame(); // –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
            }

            // –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–≥–µ–Ω –±–µ–Ω–∑–∏–Ω–∞
            const now = Date.now();
            const passed = now - state.lastRefill;
            const toRegen = Math.floor(passed / REGEN_TIME);
            if (toRegen > 0 && state.fuel < state.maxFuel) {
                state.fuel = Math.min(state.maxFuel, state.fuel + toRegen);
                state.lastRefill = now;
            }
        }

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        // --- –ì–ï–ô–ú–ü–õ–ï–ô ---
        function takeOrder() {
            if (state.fuel <= 0) {
                // –ü–æ–∫—É–ø–∫–∞ –±–µ–Ω–∑–∏–Ω–∞
                if (state.money >= 10) {
                    state.money -= 10;
                    state.fuel++;
                    saveGame();
                    updateUI();
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert("–ù–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ –±–µ–Ω–∑–∏–Ω (10üí∞)");
                }
                return;
            }

            state.fuel--;
            state.lastRefill = Date.now();
            saveGame();

            isDriving = true;
            progress = 0;
            speed = 0;
            
            // UI Update
            document.getElementById('status').innerText = "–í–µ–∑–µ–º –∫–ª–∏–µ–Ω—Ç–∞...";
            document.getElementById('status').style.color = "#f1c40f";
            document.getElementById('main-btn').innerText = "–í –ü–£–¢–ò";
            document.getElementById('main-btn').disabled = true;
            document.getElementById('car-wrap').classList.remove('floating'); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–µ–Ω–∏–µ
            
            loop = setInterval(gameLoop, 50);
            updateUI();
        }

        function gameLoop() {
            // –§–∏–∑–∏–∫–∞: —Ç—Ä–µ–Ω–∏–µ
            speed *= 0.94; // –ë—ã—Å—Ç—Ä–æ –ø–∞–¥–∞–µ—Ç
            if (speed < 0.1) speed = 0;

            progress += speed * 0.1;

            // –í–∏–∑—É–∞–ª
            document.getElementById('speed').innerText = Math.floor(speed * 20);
            document.getElementById('progress').style.width = Math.min(progress, 100) + '%';
            
            // –ö–æ–ª—å—Ü–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
            const ringScale = 0.5 + (speed / 5);
            const ringOp = Math.min(speed / 3, 1);
            document.getElementById('ring').style.transform = `scale(${ringScale})`;
            document.getElementById('ring').style.opacity = ringOp;

            if (progress >= 100) {
                finishOrder();
            }
        }

        function tapCar(e) {
            if (!isDriving) return;

            const car = carsDB.find(c => c.id === state.selected);
            
            // –£—Å–∫–æ—Ä–µ–Ω–∏–µ
            let boost = car.power;
            if (speed > 5) boost *= 0.5; // –°–ª–æ–∂–Ω–µ–µ –Ω–∞ –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
            speed += boost;
            if (speed > 8) speed = 8; // –ú–∞–∫—Å–∏–º—É–º

            // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞—Ä–∞
            const wrap = document.getElementById('car-wrap');
            wrap.style.transform = 'scale(0.95)';
            setTimeout(() => wrap.style.transform = 'scale(1)', 50);

            // –í–∏–±—Ä–∞—Ü–∏—è
            tg.HapticFeedback.impactOccurred('medium');

            // –í—Å–ø–ª—ã–≤–∞—à–∫–∞
            if (e) showPop(e.clientX, e.clientY);
        }

        function showPop(x, y) {
            const el = document.createElement('div');
            el.className = 'pop-text';
            el.innerText = '+' + Math.floor(Math.random()*5+10);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        function finishOrder() {
            clearInterval(loop);
            isDriving = false;
            
            const car = carsDB.find(c => c.id === state.selected);
            state.money += car.reward;
            saveGame();

            tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('status').innerText = "–ü—Ä–∏–µ—Ö–∞–ª–∏!";
            document.getElementById('status').style.color = "#2ecc71";
            document.getElementById('speed').innerText = "0";
            document.getElementById('ring').style.opacity = 0;
            document.getElementById('car-wrap').classList.add('floating');

            setTimeout(() => {
                if (!isDriving) {
                    document.getElementById('progress').style.width = '0%';
                    updateUI();
                }
            }, 1000);
            updateUI();
        }

        // --- –ò–ù–¢–ï–†–§–ï–ô–° ---
        function updateUI() {
            document.getElementById('balance').innerText = state.money;
            document.getElementById('fuel').innerText = state.fuel;
            
            const fuelDot = document.getElementById('fuel-dot');
            if (state.fuel > 0) {
                fuelDot.className = 'fuel-dot';
            } else {
                fuelDot.className = 'fuel-dot low';
            }

            // –ö–Ω–æ–ø–∫–∞
            const btn = document.getElementById('main-btn');
            if (!isDriving) {
                if (state.fuel > 0) {
                    btn.innerText = "–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó";
                    btn.disabled = false;
                    btn.style.background = "var(--accent)";
                    btn.style.color = "black";
                    document.getElementById('status').innerText = "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ";
                    document.getElementById('status').style.color = "#666";
                } else {
                    btn.innerText = "–ö–£–ü–ò–¢–¨ –ë–ï–ù–ó–ò–ù (10üí∞)";
                    btn.style.background = "#333";
                    btn.style.color = "white";
                    btn.disabled = false;
                    document.getElementById('status').innerText = "–ë–∞–∫ –ø—É—Å—Ç";
                    document.getElementById('status').style.color = "var(--danger)";
                }
            }

            // –ú–∞—à–∏–Ω–∞
            const curCar = carsDB.find(c => c.id === state.selected);
            document.getElementById('car-emoji').innerText = curCar.emoji;
        }

        // –¢–∞–π–º–µ—Ä —Ç–æ–ø–ª–∏–≤–∞
        setInterval(() => {
            if (state.fuel < state.maxFuel) {
                const left = REGEN_TIME - (Date.now() - state.lastRefill);
                if (left <= 0) {
                    state.fuel++;
                    state.lastRefill = Date.now();
                    saveGame();
                    updateUI();
                } else {
                    document.getElementById('timer').innerText = Math.ceil(left/1000) + '—Å';
                }
            } else {
                document.getElementById('timer').innerText = '';
            }
        }, 1000);

        // --- –ú–ê–ì–ê–ó–ò–ù ---
        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            
            carsDB.forEach(car => {
                const isOwned = state.owned.includes(car.id);
                const isSelected = state.selected === car.id;
                
                const div = document.createElement('div');
                div.className = 'car-card';
                
                let btnHtml = '';
                if (isSelected) {
                    btnHtml = `<button class="buy-btn active" disabled>–í—ã–±—Ä–∞–Ω–æ</button>`;
                } else if (isOwned) {
                    btnHtml = `<button class="buy-btn" onclick="selectCar(${car.id})">–í—ã–±—Ä–∞—Ç—å</button>`;
                } else {
                    const canBuy = state.money >= car.price;
                    btnHtml = `<button class="buy-btn" style="${canBuy ? 'background:white; color:black' : 'opacity:0.5'}" onclick="buyCar(${car.id})">${car.price}üí∞</button>`;
                }

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px">
                        <div style="font-size:32px">${car.emoji}</div>
                        <div>
                            <div style="font-weight:bold; font-size:16px">${car.name}</div>
                            <div style="font-size:12px; color:#888">+${car.reward}üí∞ / Power: ${car.power}</div>
                        </div>
                    </div>
                    ${btnHtml}
                `;
                list.appendChild(div);
            });
        }

        window.buyCar = (id) => {
            const car = carsDB.find(c => c.id === id);
            if (state.money >= car.price) {
                state.money -= car.price;
                state.owned.push(id);
                state.selected = id;
                saveGame();
                renderShop();
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            }
        };

        window.selectCar = (id) => {
            state.selected = id;
            saveGame();
            renderShop();
            updateUI();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (tab === 'game') {
                document.getElementById('shop-screen').style.display = 'none';
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else {
                renderShop();
                document.getElementById('shop-screen').style.display = 'block';
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            }
        };

        // –ó–∞–ø—É—Å–∫
        loadGame();
        updateUI();

    </script>
</body>
</html>