<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi Sim 0.3</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #212121);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --btn-color: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #323232);
            --hint-color: var(--tg-theme-hint-color, #aaaaaa);
            --green: #2ecc71;
            --red: #e74c3c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            user-select: none;
            overflow: hidden;
        }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary-bg);
            font-size: 14px;
        }
        .resource-box {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .big-text { font-size: 18px; font-weight: bold; }
        .small-text { font-size: 12px; color: var(--hint-color); }
        
        .refuel-btn {
            font-size: 12px;
            padding: 5px 10px;
            background: var(--secondary-bg);
            border-radius: 6px;
            margin-top: 5px;
            cursor: pointer;
        }

        /* --- –ò–ì–†–û–í–ê–Ø –ó–û–ù–ê --- */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .car-display {
            font-size: 100px;
            transition: transform 0.1s;
            cursor: pointer;
            z-index: 2;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        
        .car-display:active { transform: scale(0.95); }

        .tap-hint {
            font-size: 16px;
            color: var(--hint-color);
            margin-top: 15px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .progress-container {
            width: 100%;
            height: 12px;
            background: var(--secondary-bg);
            border-radius: 6px;
            margin-top: 30px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f1c40f, #f39c12);
            transition: width 0.1s linear;
        }
        
        /* –°–ø–∏–¥–æ–º–µ—Ç—Ä (—Ç–µ–∫—Å—Ç –Ω–∞–¥ –±–∞—Ä–æ–º) */
        .speed-indicator {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 10px;
            line-height: 12px;
            color: black;
            font-weight: bold;
            top: 0;
        }

        /* --- –ú–ï–ù–Æ (–í–ö–õ–ê–î–ö–ò) --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 15px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: var(--secondary-bg);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            color: var(--text-color);
            font-weight: 500;
        }
        .tab-btn.active {
            background: var(--btn-color);
            color: var(--btn-text);
        }

        /* --- –≠–ö–†–ê–ù –ú–ê–ì–ê–ó–ò–ù–ê --- */
        #shop-screen {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding-top: 20px;
        }
        .shop-item {
            background: var(--secondary-bg);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shop-info h3 { margin: 0 0 5px 0; font-size: 16px; }
        .shop-info p { margin: 0; font-size: 12px; color: var(--hint-color); }
        
        .buy-btn {
            background: var(--btn-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        .buy-btn:disabled { opacity: 0.5; }
        .equipped-badge {
            background: var(--green);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        .main-btn {
            width: 100%;
            padding: 16px;
            background: var(--btn-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
        }
        .main-btn:disabled { background: var(--secondary-bg); color: #777; }

    </style>
</head>
<body>

    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="top-bar">
        <div class="resource-box">
            <span class="small-text">–ë–∞–ª–∞–Ω—Å</span>
            <span class="big-text">üí∞ <span id="balance">0</span></span>
        </div>
        <div class="resource-box" style="align-items: flex-end;">
            <span class="big-text">‚õΩ <span id="fuel">10</span>/<span id="max-fuel">10</span></span>
            <span class="small-text" id="fuel-timer">–ü–æ–ª–Ω—ã–π –±–∞–∫</span>
            <div class="refuel-btn" onclick="buyFuel()">–ö—É–ø–∏—Ç—å +1 (5üí∞)</div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –ò–ì–†–´ -->
    <div id="game-screen" class="game-area">
        <div id="current-car" class="car-display" onclick="tapCar()">üöñ</div>
        <div id="status-text" style="margin-top: 10px; color: #888;">–°–≤–æ–±–æ–¥–µ–Ω</div>
        <div id="tap-hint" class="tap-hint">–ö–õ–ò–ö–ê–ô –ë–´–°–¢–†–ï–ï! üî•</div>
        
        <div class="progress-container">
            <div id="progress" class="progress-bar"></div>
            <div id="speed-indicator" class="speed-indicator">0 km/h</div>
        </div>

        <button id="drive-btn" class="main-btn" onclick="startOrder()">üöè –í–∑—è—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <!-- –≠–ö–†–ê–ù –ú–ê–ì–ê–ó–ò–ù–ê -->
    <div id="shop-screen"></div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('game')">üöñ –†–∞–±–æ—Ç–∞</div>
        <div class="tab-btn" onclick="switchTab('shop')">üè™ –ì–∞—Ä–∞–∂</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –î–∞–Ω–Ω—ã–µ –º–∞—à–∏–Ω
        const carsDB = [
            { id: 0, name: "–ö–æ–ø–µ–π–∫–∞", emoji: "üöô", price: 0, reward: 15, speed: 1.0 },
            { id: 1, name: "–õ–æ–≥–∞–Ω", emoji: "üöñ", price: 300, reward: 30, speed: 1.2 },
            { id: 2, name: "–ö–∞–º—Ä–∏", emoji: "üöò", price: 1500, reward: 70, speed: 1.5 },
            { id: 3, name: "–¢–µ—Å–ª–∞", emoji: "üèéÔ∏è", price: 8000, reward: 200, speed: 2.0 },
            { id: 4, name: "–õ–∞–º–±–∞", emoji: "üöÄ", price: 40000, reward: 600, speed: 3.0 }
        ];

        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
        const REGEN_TIME_MS = 60000; // 1 –º–∏–Ω—É—Ç–∞ –Ω–∞ 1 –ª–∏—Ç—Ä

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let state = {
            balance: 0,
            fuel: 10,
            maxFuel: 10,
            ownedCars: [0],
            currentCarId: 0,
            lastSaveTime: Date.now() // –î–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        };

        // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
        let isDriving = false;
        let driveInterval = null;
        let fuelInterval = null;
        let currentProgress = 0;
        let currentSpeed = 0; // –¢–µ–∫—É—â–∞—è "—Å–∫–æ—Ä–æ—Å—Ç—å" –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–≤–∏–∑—É–∞–ª—å–Ω–∞—è)

        // –ó–∞–≥—Ä—É–∑–∫–∞
        const saved = localStorage.getItem('taxiSimv03');
        if (saved) {
            state = JSON.parse(saved);
            processOfflineRegen();
        }

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const els = {
            balance: document.getElementById('balance'),
            fuel: document.getElementById('fuel'),
            maxFuel: document.getElementById('max-fuel'),
            fuelTimer: document.getElementById('fuel-timer'),
            car: document.getElementById('current-car'),
            status: document.getElementById('status-text'),
            progress: document.getElementById('progress'),
            speedInd: document.getElementById('speed-indicator'),
            driveBtn: document.getElementById('drive-btn'),
            shop: document.getElementById('shop-screen'),
            game: document.getElementById('game-screen'),
            hint: document.getElementById('tap-hint')
        };

        // --- –õ–û–ì–ò–ö–ê –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ë–ï–ù–ó–ò–ù–ê ---

        function processOfflineRegen() {
            const now = Date.now();
            const diff = now - state.lastSaveTime;
            
            // –°–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø—Ä–æ—à–ª–æ?
            const minutesPassed = Math.floor(diff / REGEN_TIME_MS);
            
            if (minutesPassed > 0 && state.fuel < state.maxFuel) {
                state.fuel = Math.min(state.maxFuel, state.fuel + minutesPassed);
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º "—Ö–≤–æ—Å—Ç–∏–∫" —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –±—ã–ª–æ —á–µ—Å—Ç–Ω–æ
            // (–≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º now)
            state.lastSaveTime = now;
            save();
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–Ω–∑–∏–Ω–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(() => {
            const now = Date.now();
            // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ª–∏—Ç—Ä–∞
            // –í –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º—ã –ø—Ä–æ—Å—Ç–æ —Å—á–∏—Ç–∞–µ–º –æ—Ç lastSaveTime
            // –ù–æ —á—Ç–æ–±—ã —Ç–∞–π–º–µ—Ä —Ç–∏–∫–∞–ª –∫—Ä–∞—Å–∏–≤–æ, —Å–¥–µ–ª–∞–µ–º –ø—Ä–æ—â–µ:
            
            if (state.fuel < state.maxFuel) {
                const diff = now - state.lastSaveTime;
                const remaining = REGEN_TIME_MS - diff;

                if (remaining <= 0) {
                    // –í—Ä–µ–º—è –ø—Ä–∏—à–ª–æ
                    state.fuel++;
                    state.lastSaveTime = now;
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
                    const sec = Math.ceil(remaining / 1000);
                    els.fuelTimer.innerText = `+1 ‚õΩ —á–µ—Ä–µ–∑ ${sec}—Å`;
                    els.fuelTimer.style.color = "#e74c3c";
                }
            } else {
                els.fuelTimer.innerText = "–ë–∞–∫ –ø–æ–ª–æ–Ω";
                els.fuelTimer.style.color = "#2ecc71";
                state.lastSaveTime = now; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ–∫–∞ –±–∞–∫ –ø–æ–ª–æ–Ω
            }
            
            updateUI(false); // false = –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
        }, 1000);

        // --- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

        function save() {
            localStorage.setItem('taxiSimv03', JSON.stringify(state));
        }

        function updateUI(renderShopFlag = true) {
            els.balance.innerText = state.balance;
            els.fuel.innerText = state.fuel;
            
            const currentCar = carsDB.find(c => c.id === state.currentCarId);
            els.car.innerText = currentCar.emoji;
            
            // –ö–Ω–æ–ø–∫–∞
            if (state.fuel <= 0 && !isDriving) {
                els.driveBtn.disabled = true;
                els.driveBtn.innerText = "–ñ–¥–∏—Ç–µ –±–µ–Ω–∑–∏–Ω...";
                els.driveBtn.style.backgroundColor = "#555";
            } else if (!isDriving) {
                els.driveBtn.disabled = false;
                els.driveBtn.innerText = "üöè –í–∑—è—Ç—å –∑–∞–∫–∞–∑ (-1‚õΩ)";
                els.driveBtn.style.backgroundColor = "var(--btn-color)";
            } else {
                els.driveBtn.disabled = true;
                els.driveBtn.innerText = "–í –ø—É—Ç–∏...";
            }

            if (renderShopFlag) renderShop();
        }

        // --- –ì–ï–ô–ú–ü–õ–ï–ô ---

        function startOrder() {
            if (isDriving || state.fuel <= 0) return;

            state.fuel -= 1;
            state.lastSaveTime = Date.now(); // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ —Ä–µ–≥–µ–Ω–∞, —Ä–∞–∑ –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏
            save();

            isDriving = true;
            currentProgress = 0;
            currentSpeed = 0; // –†–µ–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∑–∞ —Ç–∏–∫)
            
            els.status.innerText = "–í–µ–∑–µ–º –∫–ª–∏–µ–Ω—Ç–∞...";
            els.hint.style.opacity = 1;
            tg.HapticFeedback.impactOccurred('medium');

            const currentCar = carsDB.find(c => c.id === state.currentCarId);
            
            // –ë–ê–õ–ê–ù–° –°–ö–û–†–û–°–¢–ò
            // –ü–∞—Å—Å–∏–≤–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è)
            const passiveSpeed = 0.05 * currentCar.speed; 
            
            driveInterval = setInterval(() => {
                // –ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã—à–µ –ø–∞—Å—Å–∏–≤–Ω–æ–π, –æ–Ω–∞ –ø–∞–¥–∞–µ—Ç (—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ)
                if (currentSpeed > passiveSpeed) {
                    currentSpeed *= 0.92; // –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –∏–Ω–µ—Ä—Ü–∏–∏
                } else {
                    currentSpeed = passiveSpeed;
                }

                currentProgress += currentSpeed;

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
                els.progress.style.width = Math.min(currentProgress, 100) + '%';
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∫–º/—á –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                let displaySpeed = Math.floor(currentSpeed * 100 * currentCar.speed);
                els.speedInd.innerText = `${displaySpeed} km/h`;

                // –ê–Ω–∏–º–∞—Ü–∏—è –º–∞—à–∏–Ω—ã
                if(displaySpeed > 20) {
                    els.car.style.transform = `rotate(${Math.random()*4-2}deg) scale(1.05)`;
                } else {
                    els.car.style.transform = `scale(1)`;
                }

                if (currentProgress >= 100) {
                    finishOrder(currentCar);
                }
            }, 50); // –¢–∏–∫ –∫–∞–∂–¥—ã–µ 50–º—Å
            
            updateUI(false);
        }

        function tapCar() {
            if (!isDriving) return;
            
            // –ö–ª–∏–∫ –¥–∞–µ—Ç –º–æ—â–Ω—ã–π, –Ω–æ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π –±—É—Å—Ç
            // –ß–µ–º –∫—Ä—É—á–µ –º–∞—à–∏–Ω–∞, —Ç–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∫–ª–∏–∫
            const currentCar = carsDB.find(c => c.id === state.currentCarId);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
            currentSpeed += 0.8 * currentCar.speed; 
            
            // –û–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª—å (—á—Ç–æ–±—ã –Ω–µ —É–ª–µ—Ç–µ—Ç—å –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
            if(currentSpeed > 5) currentSpeed = 5;

            tg.HapticFeedback.impactOccurred('light');
        }

        function finishOrder(car) {
            clearInterval(driveInterval);
            isDriving = false;
            els.hint.style.opacity = 0;
            els.car.style.transform = `scale(1)`;
            els.status.innerText = "–ü—Ä–∏–µ—Ö–∞–ª–∏!";
            els.speedInd.innerText = "0 km/h";
            
            state.balance += car.reward;
            tg.HapticFeedback.notificationOccurred('success');
            save();
            
            setTimeout(() => {
                if(!isDriving) { // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
                    els.progress.style.width = '0%';
                    els.status.innerText = "–°–≤–æ–±–æ–¥–µ–Ω";
                    updateUI(false);
                }
            }, 1000);
            
            updateUI(false);
        }

        function buyFuel() {
            if (state.balance >= 5 && state.fuel < state.maxFuel) {
                state.balance -= 5;
                state.fuel += 1;
                tg.HapticFeedback.selectionChanged();
                save();
                updateUI(false);
            } else if (state.fuel >= state.maxFuel) {
                tg.showAlert("–ë–∞–∫ –ø–æ–ª–æ–Ω!");
            } else {
                tg.showAlert("–ù—É–∂–Ω–æ 5 –º–æ–Ω–µ—Ç!");
            }
        }

        // --- –ú–ê–ì–ê–ó–ò–ù ---

        function renderShop() {
            els.shop.innerHTML = "";
            carsDB.forEach(car => {
                const isOwned = state.ownedCars.includes(car.id);
                const isEquipped = state.currentCarId === car.id;
                
                const div = document.createElement('div');
                div.className = 'shop-item';
                
                let btnHTML = '';
                if (isEquipped) {
                    btnHTML = `<div class="equipped-badge">–í—ã–±—Ä–∞–Ω–æ</div>`;
                } else if (isOwned) {
                    btnHTML = `<button class="buy-btn" onclick="equipCar(${car.id})">–í—ã–±—Ä–∞—Ç—å</button>`;
                } else {
                    const canBuy = state.balance >= car.price;
                    btnHTML = `<button class="buy-btn" ${!canBuy ? 'disabled' : ''} onclick="buyCar(${car.id})">–ö—É–ø–∏—Ç—å ${car.price}üí∞</button>`;
                }

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="font-size:30px;">${car.emoji}</div>
                        <div class="shop-info">
                            <h3>${car.name}</h3>
                            <p>–î–æ—Ö–æ–¥: ${car.reward}üí∞ | –ú–æ—â–Ω–æ—Å—Ç—å: x${car.speed}</p>
                        </div>
                    </div>
                    ${btnHTML}
                `;
                els.shop.appendChild(div);
            });
        }

        function buyCar(id) {
            const car = carsDB.find(c => c.id === id);
            if (state.balance >= car.price) {
                state.balance -= car.price;
                state.ownedCars.push(id);
                tg.HapticFeedback.notificationOccurred('success');
                equipCar(id);
            }
        }

        function equipCar(id) {
            state.currentCarId = id;
            save();
            updateUI();
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (tabName === 'game') {
                els.game.style.display = 'flex';
                els.shop.style.display = 'none';
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else {
                els.game.style.display = 'none';
                els.shop.style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        };

        // –ó–∞–ø—É—Å–∫
        updateUI();

    </script>
</body>
</html>