<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi Clean 0.6</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F5F7FA; /* –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω */
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-light: #9CA3AF;
            --accent: #FFD600; /* –Ø—Ä–∫–∏–π –∂–µ–ª—Ç—ã–π */
            --accent-dark: #E6C200;
            --danger: #EF4444;
            --success: #10B981;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- SVG –ò–ö–û–ù–ö–ò --- */
        .icon { width: 20px; height: 20px; fill: currentColor; }
        .icon-lg { width: 28px; height: 28px; fill: currentColor; }

        /* --- –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ --- */
        .header {
            padding: 15px 20px;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-pill {
            background: var(--card-bg);
            padding: 8px 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            font-weight: 700;
            font-size: 15px;
        }
        
        .stat-pill.fuel { color: var(--text-main); }
        .stat-pill.money { color: var(--text-main); }

        /* --- –ò–ì–†–û–í–ê–Ø –ó–û–ù–ê --- */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .car-container {
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            /* –¢–µ–Ω—å –ø–æ–¥ –º–∞—à–∏–Ω–æ–π */
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.15));
        }

        .car-emoji {
            font-size: 110px;
            z-index: 2;
        }

        .speedometer {
            margin-top: 10px;
            text-align: center;
        }
        .speed-val {
            font-size: 48px;
            font-weight: 800;
            color: var(--text-main);
            letter-spacing: -2px;
            line-height: 1;
        }
        .speed-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 600;
            margin-top: 5px;
        }

        /* --- –ü–†–û–ì–†–ï–°–° --- */
        .progress-wrapper {
            width: 85%;
            margin-bottom: 20px;
        }
        .progress-bg {
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.1s linear;
        }
        .status-txt {
            text-align: center;
            font-size: 13px;
            color: var(--text-light);
            margin-top: 8px;
            font-weight: 500;
        }

        /* --- –ö–ù–û–ü–ö–ê –î–ï–ô–°–¢–í–ò–Ø --- */
        .action-area {
            padding: 20px;
            background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0));
        }

        .main-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 16px;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 214, 0, 0.4);
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .main-btn:active { transform: scale(0.98); }
        .main-btn:disabled { 
            background: #E5E7EB; 
            color: #9CA3AF; 
            box-shadow: none; 
        }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ö–†–ê–°–ò–í–ê–Ø) --- */
        .nav-bar {
            background: var(--card-bg);
            padding: 10px 20px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.03);
            border-top: 1px solid #F3F4F6;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-light);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
            width: 60px;
        }

        .nav-item.active {
            color: var(--text-main);
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ */
        .nav-item.active svg {
            fill: var(--accent);
            transform: translateY(-2px);
            filter: drop-shadow(0 4px 6px rgba(255, 214, 0, 0.3));
        }
        
        .nav-item svg { transition: all 0.2s; }

        /* --- –ú–ê–ì–ê–ó–ò–ù --- */
        #shop-screen {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 80px;
            background: var(--bg-color);
            z-index: 20;
            padding: 20px;
            overflow-y: auto;
        }
        .shop-title { font-size: 24px; font-weight: 800; margin-bottom: 20px; margin-top: 10px; }
        
        .car-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }
        .buy-btn {
            background: #F3F4F6;
            color: var(--text-main);
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
        }
        .buy-btn.highlight {
            background: var(--text-main);
            color: white;
        }

        /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–π —Ç–µ–∫—Å—Ç */
        .pop-text {
            position: absolute;
            color: var(--text-main);
            font-weight: 800;
            font-size: 20px;
            pointer-events: none;
            animation: popUp 0.6s ease-out forwards;
            opacity: 0;
        }
        @keyframes popUp {
            0% { opacity: 1; transform: translateY(0) scale(0.8); }
            50% { opacity: 1; transform: translateY(-30px) scale(1.1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1); }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞—Ä–µ–Ω–∏—è */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .floating { animation: float 3s ease-in-out infinite; }

    </style>
</head>
<body>

    <!-- SVG Definitions (hidden) -->
    <svg style="display: none;">
        <symbol id="icon-fuel" viewBox="0 0 24 24"><path d="M19.77 7.23l.01-.01-3.72-3.72L15 4.56l2.11 2.11c-.94.36-1.61 1.26-1.61 2.33a2.5 2.5 0 0 0 2.5 2.5c.36 0 .69-.08.98-.21V19h-2v-2h-2v2H6V6h5V4H6a2 2 0 0 0-2 2v16h10v-3h2v3h2a2 2 0 0 0 2-2V9c0-.69-.28-1.32-.73-1.77z"/></symbol>
        <symbol id="icon-money" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.69 1.64 1.83 1.64.93 0 1.6-.46 1.6-1.22 0-.96-.75-1.21-2.03-1.5-1.53-.35-3.1-.88-3.1-2.9 0-1.54 1.15-2.6 2.89-2.93V6h2.67v1.93c1.38.35 2.82 1.34 3.01 3.12h-1.97c-.12-.87-.72-1.39-1.59-1.39-.77 0-1.46.4-1.46 1.14 0 .96.9 1.21 2.09 1.52 1.65.43 3 1.01 3 3.05.02 1.74-1.48 2.81-3.16 3.15z"/></symbol>
        <symbol id="icon-wheel" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-2.48-.35-4.52-2.19-5.18-4.57l3.12-1.26c.38.33.86.55 1.4.63l.66 5.2zM8.32 8.64l-3.11-1.26c.76-2.28 2.76-4.01 5.18-4.32l.66 5.2a2.44 2.44 0 0 0-1.4.63l-1.33-.25zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm2.08-5.36l.66-5.2c2.42.31 4.42 2.05 5.18 4.32l-3.11 1.26c-.46-.38-.85-.59-1.33-.25l-1.4-.13zM15.68 15.36l3.11 1.26c-.66 2.38-2.7 4.22-5.18 4.57l.66-5.2c.54-.08 1.02-.3 1.4-.63z"/></symbol>
        <symbol id="icon-shop" viewBox="0 0 24 24"><path d="M21.9 8.89l-1.05-4.37c-.22-.9-1-1.52-1.91-1.52H5.06c-.91 0-1.69.62-1.91 1.52L2.1 8.89c-.24 1.02-.02 2.06.62 2.88.08.11.19.19.28.29V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-6.94c.09-.09.2-.18.28-.29.64-.82.86-1.86.62-2.88zM6 13c-1.1 0-2-.9-2-2 0-.55.22-1.05.58-1.41L5.79 5h12.42l1.21 4.59c.36.36.58.86.58 1.41 0 1.1-.9 2-2 2s-2-.9-2-2V9h-2v2c0 1.1-.9 2-2 2s-2-.9-2-2V9H8v2c0 1.1-.9 2-2 2z"/></symbol>
    </svg>

    <!-- Header -->
    <div class="header">
        <div class="stat-pill money">
            <svg class="icon" style="color:#FFD600"><use xlink:href="#icon-money"></use></svg>
            <span id="balance">0</span>
        </div>
        <div class="stat-pill fuel">
            <svg class="icon" style="color:#10B981"><use xlink:href="#icon-fuel"></use></svg>
            <span id="fuel">10</span>/10
            <span id="timer" style="font-size: 11px; color: #9CA3AF; margin-left:5px"></span>
        </div>
    </div>

    <!-- Main View -->
    <div id="game-view" class="stage">
        <div class="car-container floating" id="car-wrap" onclick="tapCar(event)">
            <div class="car-emoji" id="car-emoji">üöñ</div>
        </div>

        <div class="speedometer">
            <div class="speed-val"><span id="speed">0</span></div>
            <div class="speed-label">km/h</div>
        </div>

        <div style="flex:1"></div>

        <div class="progress-wrapper">
            <div class="progress-bg">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div id="status" class="status-txt">–ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ</div>
        </div>

        <div class="action-area">
            <button id="main-btn" class="main-btn" onclick="takeOrder()">
                <svg class="icon"><use xlink:href="#icon-wheel"></use></svg> –í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó
            </button>
        </div>
    </div>

    <!-- Shop View -->
    <div id="shop-screen">
        <div class="shop-title">–ê–≤—Ç–æ–ø–∞—Ä–∫</div>
        <div id="shop-list"></div>
    </div>

    <!-- Bottom Nav -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('game')">
            <svg class="icon-lg"><use xlink:href="#icon-wheel"></use></svg>
            <span>–†–∞–±–æ—Ç–∞</span>
        </div>
        <div class="nav-item" onclick="switchTab('shop')">
            <svg class="icon-lg"><use xlink:href="#icon-shop"></use></svg>
            <span>–ì–∞—Ä–∞–∂</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const SAVE_KEY = 'taxi_universal_save'; 
        const REGEN_TIME = 60000;

        const carsDB = [
            { id: 0, name: "Start", emoji: "üöô", price: 0, reward: 20, power: 1.0 },
            { id: 1, name: "Comfort", emoji: "üöñ", price: 500, reward: 50, power: 1.3 },
            { id: 2, name: "Sport", emoji: "üèéÔ∏è", price: 2500, reward: 150, power: 1.8 },
            { id: 3, name: "Luxury", emoji: "üöÄ", price: 10000, reward: 500, power: 2.5 }
        ];

        let state = {
            money: 0,
            fuel: 10,
            maxFuel: 10,
            lastRefill: Date.now(),
            owned: [0],
            selected: 0
        };

        let isDriving = false;
        let speed = 0;
        let progress = 0;
        let loop = null;

        function loadGame() {
            const data = localStorage.getItem(SAVE_KEY);
            if (data) state = { ...state, ...JSON.parse(data) };
            
            // Refill logic
            const passed = Date.now() - state.lastRefill;
            const toRegen = Math.floor(passed / REGEN_TIME);
            if (toRegen > 0 && state.fuel < state.maxFuel) {
                state.fuel = Math.min(state.maxFuel, state.fuel + toRegen);
                state.lastRefill = Date.now();
            }
        }

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        }

        function takeOrder() {
            if (state.fuel <= 0) {
                if (state.money >= 10) {
                    state.money -= 10;
                    state.fuel++;
                    saveGame();
                    updateUI();
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥ (10)");
                }
                return;
            }

            state.fuel--;
            state.lastRefill = Date.now();
            saveGame();

            isDriving = true;
            progress = 0;
            speed = 0;

            document.getElementById('status').innerText = "–ù–∞–±–∏—Ä–∞–π —Å–∫–æ—Ä–æ—Å—Ç—å!";
            document.getElementById('main-btn').innerText = "–í –ü–£–¢–ò";
            document.getElementById('main-btn').disabled = true;
            document.getElementById('car-wrap').classList.remove('floating');

            loop = setInterval(gameLoop, 50);
            updateUI();
        }

        function gameLoop() {
            speed *= 0.94; // –¢—Ä–µ–Ω–∏–µ
            if (speed < 0.1) speed = 0;
            progress += speed * 0.1;

            document.getElementById('speed').innerText = Math.floor(speed * 20);
            document.getElementById('progress').style.width = Math.min(progress, 100) + '%';

            if (progress >= 100) finishOrder();
        }

        function tapCar(e) {
            if (!isDriving) return;
            const car = carsDB.find(c => c.id === state.selected);
            
            let boost = car.power;
            if (speed > 5) boost *= 0.6;
            speed += boost;
            if (speed > 8) speed = 8;

            const wrap = document.getElementById('car-wrap');
            wrap.style.transform = 'scale(0.95)';
            setTimeout(() => wrap.style.transform = 'scale(1)', 50);

            tg.HapticFeedback.impactOccurred('light');
            if (e) showPop(e.clientX, e.clientY);
        }

        function showPop(x, y) {
            const el = document.createElement('div');
            el.className = 'pop-text';
            el.innerText = '+' + Math.floor(speed * 5);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        function finishOrder() {
            clearInterval(loop);
            isDriving = false;
            const car = carsDB.find(c => c.id === state.selected);
            state.money += car.reward;
            saveGame();
            
            tg.HapticFeedback.notificationOccurred('success');
            document.getElementById('status').innerText = "–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω!";
            document.getElementById('car-wrap').classList.add('floating');
            
            setTimeout(() => {
                if (!isDriving) {
                    document.getElementById('progress').style.width = '0%';
                    updateUI();
                }
            }, 1000);
            updateUI();
        }

        function updateUI() {
            document.getElementById('balance').innerText = state.money;
            document.getElementById('fuel').innerText = state.fuel;
            
            const btn = document.getElementById('main-btn');
            if (!isDriving) {
                if (state.fuel > 0) {
                    btn.innerHTML = `<svg class="icon"><use xlink:href="#icon-wheel"></use></svg> –í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó`;
                    btn.style.background = "var(--accent)";
                    btn.style.color = "black";
                    btn.disabled = false;
                    document.getElementById('status').innerText = "–ì–æ—Ç–æ–≤ –∫ –ø–æ–µ–∑–¥–∫–µ";
                } else {
                    btn.innerHTML = `<svg class="icon"><use xlink:href="#icon-fuel"></use></svg> –ö–£–ü–ò–¢–¨ –ë–ï–ù–ó–ò–ù (10)`;
                    btn.style.background = "#1F2937"; // –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –¥–ª—è –ø–æ–∫—É–ø–∫–∏
                    btn.style.color = "white";
                    btn.disabled = false;
                    document.getElementById('status').innerText = "–ù—É–∂–Ω–∞ –∑–∞–ø—Ä–∞–≤–∫–∞";
                }
            }

            const curCar = carsDB.find(c => c.id === state.selected);
            document.getElementById('car-emoji').innerText = curCar.emoji;
        }

        setInterval(() => {
            if (state.fuel < state.maxFuel) {
                const left = REGEN_TIME - (Date.now() - state.lastRefill);
                if (left <= 0) {
                    state.fuel++;
                    state.lastRefill = Date.now();
                    saveGame();
                    updateUI();
                } else {
                    document.getElementById('timer').innerText = Math.ceil(left/1000) + '—Å';
                }
            } else {
                document.getElementById('timer').innerText = '';
            }
        }, 1000);

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            carsDB.forEach(car => {
                const isOwned = state.owned.includes(car.id);
                const isSelected = state.selected === car.id;
                
                const div = document.createElement('div');
                div.className = 'car-card';
                
                let btnHtml;
                if (isSelected) btnHtml = `<button class="buy-btn" disabled>–í—ã–±—Ä–∞–Ω–æ</button>`;
                else if (isOwned) btnHtml = `<button class="buy-btn" onclick="selectCar(${car.id})">–í–∑—è—Ç—å</button>`;
                else {
                    const canBuy = state.money >= car.price;
                    const style = canBuy ? 'background:#1F2937; color:white' : 'opacity:0.5';
                    btnHtml = `<button class="buy-btn" style="${style}" onclick="buyCar(${car.id})">${car.price}</button>`;
                }

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px">
                        <div style="font-size:36px">${car.emoji}</div>
                        <div>
                            <div style="font-weight:700; font-size:16px">${car.name}</div>
                            <div style="font-size:12px; color:#9CA3AF">–ù–∞–≥—Ä–∞–¥–∞: ${car.reward}</div>
                        </div>
                    </div>
                    ${btnHtml}
                `;
                list.appendChild(div);
            });
        }

        window.buyCar = (id) => {
            const car = carsDB.find(c => c.id === id);
            if (state.money >= car.price) {
                state.money -= car.price;
                state.owned.push(id);
                state.selected = id;
                saveGame();
                renderShop();
                updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            }
        };

        window.selectCar = (id) => {
            state.selected = id;
            saveGame();
            renderShop();
            updateUI();
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (tab === 'game') {
                document.getElementById('shop-screen').style.display = 'none';
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else {
                renderShop();
                document.getElementById('shop-screen').style.display = 'block';
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            }
        };

        loadGame();
        updateUI();

    </script>
</body>
</html>