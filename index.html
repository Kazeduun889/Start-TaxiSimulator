<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi City 0.9</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-sky: #E0F2FE; /* –ù–µ–±–æ */
            --bg-city: #94A3B8; /* –ó–¥–∞–Ω–∏—è */
            --card-bg: #FFFFFF;
            --text-main: #0F172A;
            --text-sec: #64748B;
            --accent: #F59E0B; /* Amber */
            --accent-blue: #3B82F6;
            --danger: #EF4444;
            --success: #10B981;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Roboto", sans-serif;
        }

        body {
            background-color: var(--bg-sky);
            color: var(--text-main);
            font-family: var(--font);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- HEADER --- */
        .header {
            padding: 12px 16px; padding-top: 20px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            z-index: 20; position: relative;
        }
        .res-pill {
            display: flex; align-items: center; gap: 6px;
            font-weight: 700; font-size: 14px;
            background: #F1F5F9; padding: 6px 12px;
            border-radius: 12px; border: 1px solid #E2E8F0;
        }

        /* --- STAGE (CITY BG) --- */
        .stage {
            flex: 1; position: relative;
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end; /* Push content down */
            overflow: hidden;
            padding-bottom: 20px;
        }

        /* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ CSS –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã */
        .city-bg {
            position: absolute; bottom: 0; left: 0; right: 0; height: 40%;
            background-image: 
                linear-gradient(to top, #CBD5E1 0%, #CBD5E1 100%), /* Base */
                linear-gradient(to top, #94A3B8 0%, #94A3B8 100%), /* Buildings 1 */
                linear-gradient(to top, #64748B 0%, #64748B 100%); /* Buildings 2 */
            background-size: 100% 10px, 40px 60%, 25px 80%;
            background-repeat: repeat-x;
            background-position: 0 bottom, 0 bottom, 50px bottom;
            z-index: 0;
            opacity: 0.6;
        }
        
        /* –î–æ—Ä–æ–≥–∞ */
        .road-strip {
            position: absolute; bottom: 0; width: 100%; height: 100px;
            background: #334155; z-index: 1;
            border-top: 4px solid #475569;
        }
        .road-line {
            position: absolute; top: 50%; left: 0; right: 0; height: 4px;
            background: repeating-linear-gradient(90deg, #fff 0, #fff 30px, transparent 30px, transparent 60px);
            opacity: 0.5;
        }

        /* –ú–∞—à–∏–Ω–∞ */
        .car-area {
            position: relative; z-index: 10;
            margin-bottom: 30px;
            transition: transform 0.1s;
        }
        .car-emoji {
            font-size: 100px;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
        }

        /* UI Elements on Stage */
        .game-ui {
            position: absolute; top: 20px; width: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 10;
        }

        .client-bubble {
            background: white; padding: 8px 16px; border-radius: 20px;
            font-weight: 700; font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transform: translateY(-20px); opacity: 0; transition: 0.3s;
        }
        .client-bubble.show { transform: translateY(0); opacity: 1; }

        .trip-bar-box {
            width: 80%; height: 10px; background: rgba(255,255,255,0.5);
            border-radius: 5px; margin-top: 15px; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.8);
        }
        .trip-fill { height: 100%; width: 0%; background: var(--accent); }

        .speed-box {
            font-size: 40px; font-weight: 900; color: #0F172A;
            text-shadow: 0 2px 0 rgba(255,255,255,0.5);
            margin-top: 10px;
        }

        /* Button Area */
        .controls {
            z-index: 20; width: 100%; padding: 20px; box-sizing: border-box;
            background: linear-gradient(to top, rgba(255,255,255,1) 50%, transparent);
        }
        .btn-main {
            width: 100%; padding: 18px; border: none; border-radius: 16px;
            background: var(--text-main); color: white;
            font-size: 18px; font-weight: 700;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: 0.1s; display: flex; justify-content: center; gap: 10px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background: #CBD5E1; color: #94A3B8; box-shadow: none; }
        .btn-main.fuel { background: var(--accent); color: black; }

        /* --- TABS --- */
        .tab-content {
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 70px;
            background: #F8FAFC; z-index: 50; padding: 20px; overflow-y: auto;
        }
        .tab-content.active { display: block; }
        
        .section-title { font-size: 22px; font-weight: 800; margin-bottom: 15px; color: var(--text-main); }
        
        .card {
            background: white; padding: 15px; border-radius: 16px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #E2E8F0;
        }
        .btn-small {
            padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 700;
            border: none; background: #F1F5F9; color: var(--text-main);
        }
        .btn-small.buy { background: var(--text-main); color: white; }

        /* --- NAV --- */
        .nav {
            background: white; border-top: 1px solid #E2E8F0;
            padding: 10px 0; padding-bottom: env(safe-area-inset-bottom);
            display: flex; justify-content: space-around; z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #94A3B8; font-size: 10px; font-weight: 600; gap: 3px;
        }
        .nav-item.active { color: var(--text-main); }
        .nav-item svg { width: 22px; height: 22px; }

        /* Daily Bonus */
        .daily-btn {
            position: absolute; right: 20px; top: 80px;
            background: var(--accent); color: black;
            padding: 8px 12px; border-radius: 20px;
            font-weight: 700; font-size: 12px;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);
            z-index: 30; display: none;
            animation: bounce 2s infinite;
        }
        @keyframes bounce { 0%, 100% {transform:translateY(0)} 50% {transform:translateY(-5px)} }

        /* Confetti & Popups */
        .pop-text { position: absolute; font-weight: 900; font-size: 24px; animation: flyUp 0.8s forwards; pointer-events: none; }
        @keyframes flyUp { to { opacity: 0; transform: translateY(-80px); } }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <div class="res-pill">
            <span>üí∞</span> <span id="ui-money">0</span>
        </div>
        <div style="font-weight:800; font-size:12px; color:#64748B">
            LVL <span id="ui-lvl">1</span>
        </div>
        <div class="res-pill">
            <span>‚õΩ</span> <span id="ui-fuel">10</span>/<span id="ui-max-fuel">10</span>
        </div>
    </div>

    <!-- DAILY BONUS BTN -->
    <div id="btn-daily" class="daily-btn" onclick="claimDaily()">üéÅ –ë–û–ù–£–°</div>

    <!-- GAME STAGE -->
    <div id="tab-game" class="stage">
        <div class="city-bg" id="bg-city"></div>
        <div class="road-strip"><div class="road-line" id="bg-road"></div></div>

        <div class="game-ui">
            <div class="client-bubble" id="ui-client">üë§ –ö–ª–∏–µ–Ω—Ç</div>
            <div class="speed-box"><span id="ui-speed">0</span> <span style="font-size:14px; color:#64748B">KM/H</span></div>
            <div class="trip-bar-box"><div class="trip-fill" id="ui-trip"></div></div>
        </div>

        <div class="car-area" id="car-wrap" onclick="tap(event)">
            <div class="car-emoji" id="ui-car">üöñ</div>
        </div>

        <div class="controls">
            <button id="btn-main" class="btn-main" onclick="action()">–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó</button>
        </div>
    </div>

    <!-- CARS SHOP -->
    <div id="tab-cars" class="tab-content">
        <div class="section-title">–ê–≤—Ç–æ—Å–∞–ª–æ–Ω</div>
        <div id="list-cars"></div>
    </div>

    <!-- UPGRADES SHOP -->
    <div id="tab-upgrades" class="tab-content">
        <div class="section-title">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</div>
        <div class="card">
            <div>
                <div style="font-weight:700">–¢—É—Ä–±–æ-–ë–∞–∫</div>
                <div style="font-size:12px; color:#64748B">–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å. —Ç–æ–ø–ª–∏–≤–æ</div>
            </div>
            <button class="btn-small buy" id="btn-upg-tank" onclick="buyUpgrade('tank')">500üí∞</button>
        </div>
        <div class="card">
            <div>
                <div style="font-weight:700">–ù–∏—Ç—Ä–æ-–∫–ª–∏–∫</div>
                <div style="font-size:12px; color:#64748B">–£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç —Ç–∞–ø–∞ +10%</div>
            </div>
            <button class="btn-small buy" id="btn-upg-click" onclick="buyUpgrade('click')">1000üí∞</button>
        </div>
    </div>

    <!-- NAV -->
    <div class="nav">
        <div class="nav-item active" onclick="switchTab('game', this)">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>
            –†—É–ª—å
        </div>
        <div class="nav-item" onclick="switchTab('cars', this)">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
            –ú–∞—à–∏–Ω—ã
        </div>
        <div class="nav-item" onclick="switchTab('upgrades', this)">
            <svg fill="currentColor" viewBox="0 0 24 24"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/></svg>
            –¢—é–Ω–∏–Ω–≥
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- DATA ---
        const carsDB = [
            { id: 0, name: "Start", emoji: "üöô", price: 0, reward: 20, power: 1.0 },
            { id: 1, name: "Classic", emoji: "üöñ", price: 1000, reward: 50, power: 1.3 },
            { id: 2, name: "Racer", emoji: "üèéÔ∏è", price: 5000, reward: 150, power: 1.7 },
            { id: 3, name: "Monster", emoji: "üöö", price: 20000, reward: 400, power: 2.5 },
            { id: 4, name: "UFO", emoji: "üõ∏", price: 100000, reward: 1000, power: 4.0 }
        ];
        
        const clients = [
            { t: "–°—Ç—É–¥–µ–Ω—Ç", b: 0 }, { t: "–ë–∞–±—É–ª—è", b: 10 }, 
            { t: "–¢—É—Ä–∏—Å—Ç", b: 25 }, { t: "–ú–∞–∂–æ—Ä", b: 100 }
        ];

        // --- STATE ---
        let state = {
            money: 0, xp: 0, level: 1, fuel: 10,
            lastRefill: Date.now(),
            lastBonus: 0,
            owned: [0], selected: 0,
            upgrades: { tank: 0, click: 0 } // levels
        };

        // Runtime
        let isDriving = false;
        let speed = 0;
        let progress = 0;
        let loop = null;
        let bgOffset = 0;
        let currentClient = null;

        // --- CORE ---
        function load() {
            let s = localStorage.getItem('taxi_city_09');
            if(s) {
                let parsed = JSON.parse(s);
                state = {...state, ...parsed};
                if(!state.upgrades) state.upgrades = { tank:0, click:0 }; // migration
            }
            
            // Fuel Regen
            let max = getMaxFuel();
            let passed = Math.floor((Date.now() - state.lastRefill)/60000);
            if(passed > 0 && state.fuel < max) {
                state.fuel = Math.min(max, state.fuel + passed);
                state.lastRefill = Date.now();
            }
        }
        function save() { localStorage.setItem('taxi_city_09', JSON.stringify(state)); }

        // --- HELPERS ---
        function getMaxFuel() { return 10 + state.upgrades.tank; }
        function getClickPower() { 
            let car = carsDB.find(c=>c.id === state.selected);
            return car.power * (1 + (state.upgrades.click * 0.1));
        }

        // --- GAMEPLAY ---
        function action() {
            if(state.fuel <= 0) {
                if(state.money >= 10) { 
                    state.money-=10; state.fuel++; save(); updateUI(); 
                    tg.HapticFeedback.notificationOccurred('success');
                } else tg.showAlert("–ù—É–∂–Ω–æ 10üí∞ –Ω–∞ –±–µ–Ω–∑–∏–Ω!");
                return;
            }

            // Start
            state.fuel--; 
            state.lastRefill = Date.now();
            
            // Client
            currentClient = clients[Math.floor(Math.random()*clients.length)];
            document.getElementById('ui-client').innerText = "üë§ " + currentClient.t;
            document.getElementById('ui-client').classList.add('show');

            isDriving = true;
            progress = 0;
            speed = 0;
            save(); updateUI();

            loop = setInterval(() => {
                // Physics
                speed *= 0.95; // Drag
                if(speed < 0.1) speed = 0;
                progress += speed * 0.12;

                // Animation BG
                bgOffset -= speed * 2;
                document.getElementById('bg-city').style.backgroundPositionX = 
                    `${bgOffset*0.2}px, ${bgOffset*0.5}px, ${bgOffset}px`;
                document.getElementById('bg-road').style.backgroundPositionX = `${bgOffset}px`;

                // Car Suspension
                let bounce = (speed > 1) ? Math.sin(Date.now()/50)*2 : 0;
                document.getElementById('ui-car').style.transform = `translateY(${bounce}px)`;

                // UI
                document.getElementById('ui-speed').innerText = Math.floor(speed * 20);
                document.getElementById('ui-trip').style.width = Math.min(progress, 100)+'%';

                if(progress >= 100) finish();
            }, 50);
        }

        function tap(e) {
            if(!isDriving) return;
            let p = getClickPower();
            if(speed > 5) p *= 0.5;
            speed += p;
            if(speed > 9) speed = 9;

            // Visual
            let wrap = document.getElementById('car-wrap');
            wrap.style.transform = "scale(0.95)";
            setTimeout(()=>wrap.style.transform="scale(1)", 80);
            
            tg.HapticFeedback.impactOccurred('light');

            if(e) {
                let el = document.createElement('div');
                el.className = 'pop-text';
                el.innerText = "üí®";
                el.style.left = e.clientX+'px'; el.style.top = e.clientY+'px';
                document.body.appendChild(el);
                setTimeout(()=>el.remove(), 800);
            }
        }

        function finish() {
            clearInterval(loop);
            isDriving = false;
            document.getElementById('ui-client').classList.remove('show');
            document.getElementById('ui-trip').style.width = '0%';
            
            let car = carsDB.find(c=>c.id === state.selected);
            let total = car.reward + currentClient.b;
            state.money += total;
            
            // Level
            state.xp += 20;
            if(state.xp >= state.level*100) {
                state.xp = 0; state.level++;
                state.fuel = getMaxFuel();
                tg.showAlert("–ù–û–í–´–ô –£–†–û–í–ï–ù–¨! üéâ");
            }
            
            save(); updateUI();
            tg.HapticFeedback.notificationOccurred('success');
        }

        // --- UPGRADES ---
        function buyUpgrade(type) {
            let cost = 0;
            if(type === 'tank') cost = 500 * (state.upgrades.tank + 1);
            if(type === 'click') cost = 1000 * (state.upgrades.click + 1);

            if(state.money >= cost) {
                state.money -= cost;
                state.upgrades[type]++;
                save(); updateUI();
                tg.HapticFeedback.notificationOccurred('success');
            } else tg.showAlert(`–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç! –ù—É–∂–Ω–æ ${cost}üí∞`);
        }

        // --- UI ---
        function updateUI() {
            document.getElementById('ui-money').innerText = state.money;
            document.getElementById('ui-lvl').innerText = state.level;
            document.getElementById('ui-fuel').innerText = state.fuel;
            document.getElementById('ui-max-fuel').innerText = getMaxFuel();
            
            // Car Emoji
            let c = carsDB.find(x=>x.id===state.selected);
            document.getElementById('ui-car').innerText = c.emoji;

            // Button
            let btn = document.getElementById('btn-main');
            if(!isDriving) {
                if(state.fuel > 0) {
                    btn.innerText = "–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó"; btn.className = "btn-main"; btn.disabled = false;
                } else {
                    btn.innerText = "–ó–ê–ü–†–ê–í–ò–¢–¨–°–Ø (10üí∞)"; btn.className = "btn-main fuel"; btn.disabled = false;
                }
            } else {
                btn.innerText = "–í –ü–£–¢–ò..."; btn.disabled = true; btn.className = "btn-main";
            }

            // Shop Prices
            renderShop();
            renderUpgrades();

            // Daily
            let diff = Date.now() - state.lastBonus;
            document.getElementById('btn-daily').style.display = (diff > 86400000) ? 'block' : 'none';
        }

        function renderShop() {
            let html = '';
            carsDB.forEach(car => {
                let owned = state.owned.includes(car.id);
                let btn = owned 
                    ? `<button class="btn-small" onclick="selectCar(${car.id})">–í–∑—è—Ç—å</button>`
                    : `<button class="btn-small buy" onclick="buyCar(${car.id})">${car.price}üí∞</button>`;
                if(state.selected === car.id) btn = `<button class="btn-small" disabled>–í—ã–±—Ä–∞–Ω–æ</button>`;
                
                html += `<div class="card">
                    <div style="font-size:30px; margin-right:10px">${car.emoji}</div>
                    <div style="flex:1">
                        <div style="font-weight:700">${car.name}</div>
                        <div style="font-size:12px;color:#64748B">+${car.reward}üí∞</div>
                    </div>
                    ${btn}
                </div>`;
            });
            document.getElementById('list-cars').innerHTML = html;
        }

        function renderUpgrades() {
            let costTank = 500 * (state.upgrades.tank + 1);
            let costClick = 1000 * (state.upgrades.click + 1);
            document.getElementById('btn-upg-tank').innerText = `${costTank}üí∞ (Lvl ${state.upgrades.tank})`;
            document.getElementById('btn-upg-click').innerText = `${costClick}üí∞ (Lvl ${state.upgrades.click})`;
        }

        // --- ACTIONS ---
        function buyCar(id) {
            let c = carsDB.find(x=>x.id===id);
            if(state.money >= c.price) {
                state.money -= c.price;
                state.owned.push(id);
                state.selected = id;
                save(); updateUI();
            }
        }
        function selectCar(id) { state.selected = id; save(); updateUI(); }

        function claimDaily() {
            state.money += 100;
            state.lastBonus = Date.now();
            save(); updateUI();
            tg.showAlert("–ü–æ–ª—É—á–µ–Ω–æ 100 –º–æ–Ω–µ—Ç!");
        }

        window.switchTab = function(id, el) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        // Fuel Timer
        setInterval(() => {
            if(state.fuel < getMaxFuel() && (Date.now()-state.lastRefill >= 60000)) {
                state.fuel++; state.lastRefill = Date.now(); save(); updateUI();
            }
        }, 1000);

        load(); updateUI();

    </script>
</body>
</html>