<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi Pro 0.7</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #111827;
            --text-sec: #6B7280;
            --accent: #FBBF24; /* Taxi Gold */
            --accent-blue: #3B82F6; /* XP Blue */
            --danger: #EF4444;
            --success: #10B981;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- HEADER --- */
        .header {
            padding: 12px 16px;
            padding-top: 20px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 10;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ */
        .res-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-main);
            background: #F9FAFB;
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
        }

        /* --- XP LEVEL SYSTEM (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫—Ä–∞—Å–æ—Ç–∞) --- */
        .level-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }
        .level-badge {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--accent-blue);
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        .xp-track {
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        .xp-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #3B82F6, #60A5FA);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .level-num {
            position: absolute;
            top: 15px;
            font-size: 10px;
            color: #9CA3AF;
        }

        /* --- GAME AREA --- */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .car-area {
            position: relative;
            margin-bottom: 20px;
            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* –¢–µ–Ω—å –º–∞—à–∏–Ω—ã */
        .car-shadow {
            position: absolute;
            bottom: -10px;
            left: 10%;
            width: 80%;
            height: 15px;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 70%);
            z-index: 0;
            transition: transform 0.1s;
        }

        .car-emoji {
            font-size: 100px;
            z-index: 2;
            position: relative;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
        }

        .speed-display {
            text-align: center;
            margin-bottom: 30px;
        }
        .speed-num { font-size: 42px; font-weight: 900; line-height: 1; letter-spacing: -1px; }
        .speed-unit { font-size: 12px; color: var(--text-sec); font-weight: 600; text-transform: uppercase; }

        /* Progress Bar (–ü–æ–µ–∑–¥–∫–∞) */
        .trip-progress {
            width: 80%;
            height: 10px;
            background: #E5E7EB;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .trip-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.1s linear;
        }
        .status-text {
            font-size: 13px;
            color: var(--text-sec);
            height: 20px;
        }

        /* --- BUTTONS --- */
        .action-container {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,0));
        }

        .btn-main {
            width: 100%;
            height: 56px;
            border: none;
            border-radius: 16px;
            background: var(--text-main); /* Black */
            color: white;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.1s, background 0.2s;
        }
        
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background: #D1D5DB; color: #9CA3AF; box-shadow: none; cursor: not-allowed; }

        .btn-main.fuel-mode { background: var(--accent); color: black; }

        /* --- NAV BAR --- */
        .nav {
            background: var(--card-bg);
            border-top: 1px solid #E5E7EB;
            padding: 8px 0;
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            justify-content: space-around;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 50px;
            color: #9CA3AF;
            font-size: 10px;
            font-weight: 600;
            gap: 4px;
        }
        .nav-item.active { color: var(--text-main); }
        .nav-item svg { width: 24px; height: 24px; stroke-width: 2; }

        /* --- ICONS SVG --- */
        .icon { width: 18px; height: 18px; }

        /* --- SHOP --- */
        #shop-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 65px;
            background: var(--bg-color);
            z-index: 50;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }
        .shop-card {
            background: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            border: 1px solid #E5E7EB;
        }
        .btn-buy {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            border: none;
            background: #F3F4F6;
            color: var(--text-main);
        }
        .btn-buy.active { background: var(--text-main); color: white; }

        /* Animations */
        @keyframes float { 0%{transform:translateY(0)} 50%{transform:translateY(-5px)} 100%{transform:translateY(0)} }
        .anim-float { animation: float 3s ease-in-out infinite; }
        
        .pop-text {
            position: absolute;
            font-weight: 900;
            font-size: 20px;
            color: var(--text-main);
            pointer-events: none;
            animation: popUp 0.6s forwards;
        }
        @keyframes popUp { 0%{opacity:1; transform:translateY(0) scale(0.5)} 100%{opacity:0; transform:translateY(-60px) scale(1.2)} }

    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <!-- Money -->
        <div class="res-pill">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span id="ui-money">0</span>
        </div>

        <!-- LEVEL (–¶–µ–Ω—Ç—Ä) -->
        <div class="level-container">
            <div class="level-badge">–£–†–û–í–ï–ù–¨ <span id="ui-lvl">1</span></div>
            <div class="xp-track">
                <div class="xp-fill" id="ui-xp-fill"></div>
            </div>
        </div>

        <!-- Fuel -->
        <div class="res-pill">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <span id="ui-fuel">10</span>/10
        </div>
    </div>

    <!-- MAIN GAME -->
    <div id="game-layer" class="stage">
        
        <div class="car-area anim-float" id="car-wrap" onclick="tap(event)">
            <div class="car-emoji" id="ui-car">üöñ</div>
            <div class="car-shadow" id="car-shadow"></div>
        </div>

        <div class="speed-display">
            <div class="speed-num" id="ui-speed">0</div>
            <div class="speed-unit">km/h</div>
        </div>

        <div class="trip-progress">
            <div class="trip-fill" id="ui-trip-fill"></div>
        </div>
        <div class="status-text" id="ui-status">–°–≤–æ–±–æ–¥–µ–Ω</div>

        <div class="action-container">
            <button id="btn-main" class="btn-main" onclick="action()">
                –í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó
            </button>
        </div>
    </div>

    <!-- SHOP -->
    <div id="shop-layer">
        <h2 style="margin:10px 0 20px 0;">–ì–∞—Ä–∞–∂</h2>
        <div id="shop-list"></div>
    </div>

    <!-- NAV -->
    <div class="nav">
        <div class="nav-item active" onclick="setTab('game')">
            <!-- Icon: Home -->
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span>–†–∞–±–æ—Ç–∞</span>
        </div>
        <div class="nav-item" onclick="setTab('shop')">
            <!-- Icon: Car/Grid -->
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            <span>–ì–∞—Ä–∞–∂</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –î–∞–Ω–Ω—ã–µ
        const cars = [
            { id: 0, name: "Start", emoji: "üöô", price: 0, reward: 20, power: 1.0 },
            { id: 1, name: "Sedan", emoji: "üöñ", price: 500, reward: 50, power: 1.3 },
            { id: 2, name: "Sport", emoji: "üèéÔ∏è", price: 2500, reward: 150, power: 1.6 },
            { id: 3, name: "Hyper", emoji: "üöÄ", price: 10000, reward: 500, power: 2.2 }
        ];

        let state = {
            money: 0,
            xp: 0,
            level: 1,
            fuel: 10,
            maxFuel: 10,
            lastRefill: Date.now(),
            owned: [0],
            selected: 0
        };

        let isRunning = false;
        let speed = 0;
        let progress = 0;
        let loop = null;
        let xpToNext = 100;

        // –ó–∞–≥—Ä—É–∑–∫–∞
        const load = () => {
            let data = localStorage.getItem('taxi_universal_save');
            if(data) {
                let parsed = JSON.parse(data);
                state = { ...state, ...parsed }; // Merge
            }
            // –†–µ–≥–µ–Ω –±–µ–Ω–∑–∏–Ω–∞
            let passed = Math.floor((Date.now() - state.lastRefill)/60000);
            if(passed > 0 && state.fuel < state.maxFuel) {
                state.fuel = Math.min(state.maxFuel, state.fuel + passed);
                state.lastRefill = Date.now();
            }
        };

        const save = () => localStorage.setItem('taxi_universal_save', JSON.stringify(state));

        // UI
        const ui = {
            money: document.getElementById('ui-money'),
            fuel: document.getElementById('ui-fuel'),
            lvl: document.getElementById('ui-lvl'),
            xpFill: document.getElementById('ui-xp-fill'),
            car: document.getElementById('ui-car'),
            speed: document.getElementById('ui-speed'),
            trip: document.getElementById('ui-trip-fill'),
            btn: document.getElementById('btn-main'),
            status: document.getElementById('ui-status'),
            wrap: document.getElementById('car-wrap'),
            shadow: document.getElementById('car-shadow')
        };

        const render = () => {
            ui.money.innerText = state.money;
            ui.fuel.innerText = state.fuel;
            ui.lvl.innerText = state.level;
            
            // XP Calculation
            xpToNext = state.level * 100;
            let xpPct = (state.xp / xpToNext) * 100;
            ui.xpFill.style.width = Math.min(xpPct, 100) + '%';

            let car = cars.find(c => c.id === state.selected);
            ui.car.innerText = car.emoji;

            // Button State
            if(!isRunning) {
                if(state.fuel > 0) {
                    ui.btn.innerText = "–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó";
                    ui.btn.className = "btn-main";
                    ui.btn.disabled = false;
                    ui.status.innerText = "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ";
                } else {
                    ui.btn.innerText = "–ö–£–ü–ò–¢–¨ –¢–û–ü–õ–ò–í–û (10üí∞)";
                    ui.btn.className = "btn-main fuel-mode"; // Yellow button
                    ui.btn.disabled = false;
                    ui.status.innerText = "–ë–∞–∫ –ø—É—Å—Ç";
                }
            } else {
                ui.btn.innerText = "–í –ü–£–¢–ò...";
                ui.btn.className = "btn-main";
                ui.btn.disabled = true;
                ui.status.innerText = "–¢–∞–ø–∞–π, —á—Ç–æ–±—ã –µ—Ö–∞—Ç—å!";
            }
        };

        // Logic
        const action = () => {
            if(state.fuel <= 0) {
                if(state.money >= 10) {
                    state.money -= 10;
                    state.fuel++;
                    save();
                    render();
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç!");
                }
                return;
            }

            // Start Drive
            state.fuel--;
            state.lastRefill = Date.now();
            save();
            
            isRunning = true;
            progress = 0;
            speed = 0;
            ui.wrap.classList.remove('anim-float');
            render();
            
            loop = setInterval(() => {
                // Physics
                speed *= 0.95; 
                if(speed < 0.1) speed = 0;
                
                progress += speed * 0.15;
                
                // UI updates in loop
                ui.speed.innerText = Math.floor(speed * 20);
                ui.trip.style.width = Math.min(progress, 100) + '%';
                
                // Shadow scale based on speed (fake lift)
                let shadowScale = 1 - (speed/10);
                ui.shadow.style.transform = `scale(${shadowScale})`;

                if(progress >= 100) finish();

            }, 50);
        };

        const tap = (e) => {
            if(!isRunning) return;
            
            let car = cars.find(c => c.id === state.selected);
            let boost = car.power;
            
            if(speed > 5) boost *= 0.5;
            speed += boost;
            if(speed > 8) speed = 8;

            // Anim
            ui.wrap.style.transform = "scale(0.95) translateY(2px)";
            setTimeout(() => ui.wrap.style.transform = "scale(1) translateY(0)", 80);
            
            tg.HapticFeedback.impactOccurred('light');
            
            // Pop text
            if(e) {
                let el = document.createElement('div');
                el.className = 'pop-text';
                el.innerText = Math.floor(speed*10);
                el.style.left = e.clientX + 'px';
                el.style.top = e.clientY + 'px';
                document.body.appendChild(el);
                setTimeout(()=>el.remove(), 600);
            }
        };

        const finish = () => {
            clearInterval(loop);
            isRunning = false;
            ui.wrap.classList.add('anim-float');
            ui.trip.style.width = '0%';
            ui.speed.innerText = '0';
            
            let car = cars.find(c => c.id === state.selected);
            state.money += car.reward;
            
            // XP logic
            state.xp += 25; // XP per ride
            if(state.xp >= xpToNext) {
                state.xp -= xpToNext;
                state.level++;
                state.fuel = state.maxFuel; // Full tank on level up!
                tg.showAlert(`–£—Ä–æ–≤–µ–Ω—å ${state.level}! –ü–æ–ª–Ω—ã–π –±–∞–∫! üéâ`);
            }

            save();
            render();
            tg.HapticFeedback.notificationOccurred('success');
        };

        // Shop
        const renderShop = () => {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            cars.forEach(c => {
                let isOwned = state.owned.includes(c.id);
                let isSel = state.selected === c.id;
                
                let btn = '';
                if(isSel) btn = `<button class="btn-buy active">–í–´–ë–†–ê–ù–û</button>`;
                else if(isOwned) btn = `<button class="btn-buy" onclick="pick(${c.id})">–í–ó–Ø–¢–¨</button>`;
                else btn = `<button class="btn-buy" onclick="buy(${c.id})">${c.price}üí∞</button>`;

                let div = document.createElement('div');
                div.className = 'shop-card';
                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="font-size:30px">${c.emoji}</div>
                        <div>
                            <div style="font-weight:700">${c.name}</div>
                            <div style="font-size:11px; color:#6B7280">–î–æ—Ö–æ–¥: ${c.reward}</div>
                        </div>
                    </div>
                    ${btn}
                `;
                list.appendChild(div);
            });
        };

        window.buy = (id) => {
            let c = cars.find(x => x.id === id);
            if(state.money >= c.price) {
                state.money -= c.price;
                state.owned.push(id);
                state.selected = id;
                save(); render(); renderShop();
            }
        };
        window.pick = (id) => {
            state.selected = id;
            save(); render(); renderShop();
        };

        window.setTab = (t) => {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(t === 'game') {
                document.getElementById('shop-layer').style.display = 'none';
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else {
                renderShop();
                document.getElementById('shop-layer').style.display = 'block';
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            }
        };

        // Fuel Timer
        setInterval(() => {
            if(state.fuel < state.maxFuel) {
                let diff = Date.now() - state.lastRefill;
                if(diff >= 60000) {
                    state.fuel++;
                    state.lastRefill = Date.now();
                    save(); render();
                }
            }
        }, 1000);

        load();
        render();

    </script>
</body>
</html>