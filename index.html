<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taxi Pro 0.8</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #111827;
            --text-sec: #6B7280;
            --accent: #FBBF24;
            --accent-blue: #3B82F6;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- HEADER --- */
        .header {
            padding: 12px 16px;
            padding-top: 20px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .res-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-main);
            background: #F9FAFB;
            padding: 6px 12px;
            border-radius: 12px;
            border: 1px solid #E5E7EB;
        }

        .level-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
        }
        .level-badge {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--accent-blue);
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        .xp-track {
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
        }
        .xp-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #3B82F6, #60A5FA);
            transition: width 0.3s ease;
        }

        /* --- STAGE --- */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .client-info {
            position: absolute;
            top: 20px;
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }
        .client-info.visible { opacity: 1; transform: translateY(0); }

        .car-area {
            position: relative;
            margin-bottom: 30px;
            transition: transform 0.1s;
        }
        .car-emoji {
            font-size: 110px;
            z-index: 2;
            position: relative;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }

        .speed-display { text-align: center; margin-bottom: 20px; }
        .speed-num { font-size: 48px; font-weight: 900; line-height: 1; }
        .speed-unit { font-size: 12px; color: var(--text-sec); font-weight: 700; text-transform: uppercase; }

        .trip-progress {
            width: 85%;
            height: 12px;
            background: #E5E7EB;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
            position: relative;
        }
        .trip-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.1s linear;
        }

        .status-text {
            font-size: 13px;
            color: var(--text-sec);
            height: 20px;
            font-weight: 500;
        }

        /* --- ACTION AREA --- */
        .action-container {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        .btn-main {
            width: 100%;
            height: 60px;
            border: none;
            border-radius: 18px;
            background: var(--text-main);
            color: white;
            font-size: 17px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.1s;
        }
        .btn-main:active { transform: scale(0.97); }
        .btn-main:disabled { background: #D1D5DB; color: #9CA3AF; box-shadow: none; }
        .btn-main.fuel-mode { background: var(--accent); color: black; }

        /* --- MODAL (LEVEL UP) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-card {
            background: white;
            width: 80%;
            padding: 30px;
            border-radius: 24px;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-title { font-size: 24px; font-weight: 900; margin-bottom: 10px; }
        .modal-text { color: var(--text-sec); margin-bottom: 20px; font-size: 14px; }
        .btn-modal {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
        }

        /* --- NAV --- */
        .nav {
            background: var(--card-bg);
            border-top: 1px solid #E5E7EB;
            padding: 8px 0;
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            justify-content: space-around;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
            color: #9CA3AF;
            font-size: 10px;
            font-weight: 600;
            gap: 4px;
        }
        .nav-item.active { color: var(--text-main); }
        .nav-item svg { width: 24px; height: 24px; }

        /* --- SHOP & ICONS --- */
        #shop-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 65px;
            background: var(--bg-color); z-index: 50;
            padding: 20px; overflow-y: auto; display: none;
        }
        .shop-card {
            background: white; padding: 16px; border-radius: 16px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .btn-buy {
            padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 700;
            border: none; background: #F3F4F6; color: var(--text-main);
        }
        .icon { width: 18px; height: 18px; }

        /* --- ANIMATIONS --- */
        .pop-text {
            position: absolute; font-weight: 900; font-size: 22px; color: var(--text-main);
            pointer-events: none; animation: popUp 0.6s forwards;
        }
        @keyframes popUp { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-50px)} }
        
        .confetti {
            position: absolute; width: 10px; height: 10px; background: #f00;
            animation: confetti-fall 3s linear forwards;
        }
        @keyframes confetti-fall { 0%{transform:translateY(-10vh) rotate(0deg)} 100%{transform:translateY(110vh) rotate(720deg)} }

    </style>
</head>
<body>

    <!-- LEVEL UP MODAL -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-card">
            <div style="font-size: 50px; margin-bottom: 10px;">üéâ</div>
            <div class="modal-title">–ù–û–í–´–ô –£–†–û–í–ï–ù–¨!</div>
            <div class="modal-text">–¢—ã –¥–æ—Å—Ç–∏–≥ —É—Ä–æ–≤–Ω—è <span id="modal-lvl">2</span>!<br>–ë–∞–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—Ä–∞–≤–ª–µ–Ω.</div>
            <button class="btn-modal" onclick="closeModal()">–ö–†–£–¢–û</button>
        </div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div class="res-pill">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span id="ui-money">0</span>
        </div>
        <div class="level-container">
            <div class="level-badge">LVL <span id="ui-lvl">1</span></div>
            <div class="xp-track"><div class="xp-fill" id="ui-xp-fill"></div></div>
        </div>
        <div class="res-pill">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <span id="ui-fuel">10</span>/10
        </div>
    </div>

    <!-- STAGE -->
    <div id="game-layer" class="stage">
        
        <div id="client-bubble" class="client-info">üë§ –°—Ç—É–¥–µ–Ω—Ç</div>

        <div class="car-area" id="car-wrap" onclick="tap(event)">
            <div class="car-emoji" id="ui-car">üöñ</div>
        </div>

        <div class="speed-display">
            <div class="speed-num" id="ui-speed">0</div>
            <div class="speed-unit">km/h</div>
        </div>

        <div class="trip-progress"><div class="trip-fill" id="ui-trip-fill"></div></div>
        <div class="status-text" id="ui-status">–°–≤–æ–±–æ–¥–µ–Ω</div>

        <div class="action-container">
            <button id="btn-main" class="btn-main" onclick="action()">–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó</button>
        </div>
    </div>

    <!-- SHOP -->
    <div id="shop-layer">
        <h2 style="margin:10px 0 20px 0;">–ì–∞—Ä–∞–∂</h2>
        <div id="shop-list"></div>
    </div>

    <!-- NAV -->
    <div class="nav">
        <div class="nav-item active" onclick="setTab('game')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span>–†–∞–±–æ—Ç–∞</span>
        </div>
        <div class="nav-item" onclick="setTab('shop')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            <span>–ì–∞—Ä–∞–∂</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // –ë–î
        const cars = [
            { id: 0, name: "Start", emoji: "üöô", price: 0, reward: 20, power: 1.0 },
            { id: 1, name: "Sedan", emoji: "üöñ", price: 500, reward: 50, power: 1.3 },
            { id: 2, name: "Sport", emoji: "üèéÔ∏è", price: 2500, reward: 150, power: 1.6 },
            { id: 3, name: "Hyper", emoji: "üöÄ", price: 10000, reward: 500, power: 2.2 }
        ];

        const clients = [
            { name: "–°—Ç—É–¥–µ–Ω—Ç", emoji: "üéì", tip: 0 },
            { name: "–ë–∞–±—É—à–∫–∞", emoji: "üëµ", tip: 5 },
            { name: "–ë–∏–∑–Ω–µ—Å–º–µ–Ω", emoji: "üíº", tip: 50 },
            { name: "–¢—É—Ä–∏—Å—Ç", emoji: "üì∏", tip: 20 },
            { name: "–ö–æ—Ç", emoji: "üê±", tip: 100 }
        ];

        let state = {
            money: 0, xp: 0, level: 1, fuel: 10, maxFuel: 10, lastRefill: Date.now(), owned: [0], selected: 0
        };

        let isRunning = false;
        let speed = 0;
        let progress = 0;
        let loop = null;
        let currentClient = null;

        // LOAD / SAVE
        const load = () => {
            let d = localStorage.getItem('taxi_universal_save');
            if(d) state = { ...state, ...JSON.parse(d) };
            
            let passed = Math.floor((Date.now() - state.lastRefill)/60000);
            if(passed > 0 && state.fuel < state.maxFuel) {
                state.fuel = Math.min(state.maxFuel, state.fuel + passed);
                state.lastRefill = Date.now();
            }
        };
        const save = () => localStorage.setItem('taxi_universal_save', JSON.stringify(state));

        // UI REF
        const ui = {
            money: document.getElementById('ui-money'),
            fuel: document.getElementById('ui-fuel'),
            lvl: document.getElementById('ui-lvl'),
            xpFill: document.getElementById('ui-xp-fill'),
            car: document.getElementById('ui-car'),
            speed: document.getElementById('ui-speed'),
            trip: document.getElementById('ui-trip-fill'),
            btn: document.getElementById('btn-main'),
            status: document.getElementById('ui-status'),
            wrap: document.getElementById('car-wrap'),
            clientBubble: document.getElementById('client-bubble')
        };

        const render = () => {
            ui.money.innerText = state.money;
            ui.fuel.innerText = state.fuel;
            ui.lvl.innerText = state.level;
            
            let nextXp = state.level * 100;
            ui.xpFill.style.width = Math.min((state.xp / nextXp) * 100, 100) + '%';

            let car = cars.find(c => c.id === state.selected);
            ui.car.innerText = car.emoji;

            if(!isRunning) {
                if(state.fuel > 0) {
                    ui.btn.innerText = "–í–ó–Ø–¢–¨ –ó–ê–ö–ê–ó";
                    ui.btn.className = "btn-main";
                    ui.btn.disabled = false;
                    ui.status.innerText = "–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ";
                } else {
                    ui.btn.innerText = "–ö–£–ü–ò–¢–¨ –ë–ï–ù–ó–ò–ù (10üí∞)";
                    ui.btn.className = "btn-main fuel-mode";
                    ui.btn.disabled = false;
                    ui.status.innerText = "–ë–∞–∫ –ø—É—Å—Ç";
                }
            } else {
                ui.btn.innerText = "–í –ü–£–¢–ò...";
                ui.btn.className = "btn-main";
                ui.btn.disabled = true;
                ui.status.innerText = "–ù–∞–∂–º–∏ –Ω–∞ –º–∞—à–∏–Ω—É –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏!";
            }
        };

        // GAMEPLAY
        const action = () => {
            if(state.fuel <= 0) {
                if(state.money >= 10) { state.money -= 10; state.fuel++; save(); render(); tg.HapticFeedback.notificationOccurred('success'); }
                else tg.showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!");
                return;
            }

            state.fuel--;
            state.lastRefill = Date.now();
            
            // –í—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
            currentClient = clients[Math.floor(Math.random() * clients.length)];
            ui.clientBubble.innerText = `${currentClient.emoji} ${currentClient.name}`;
            ui.clientBubble.classList.add('visible');

            isRunning = true;
            progress = 0;
            speed = 0;
            save(); render();
            
            loop = setInterval(() => {
                speed *= 0.95; 
                if(speed < 0.1) speed = 0;
                progress += speed * 0.15;
                
                ui.speed.innerText = Math.floor(speed * 20);
                ui.trip.style.width = Math.min(progress, 100) + '%';
                
                if(progress >= 100) finish();
            }, 50);
        };

        const tap = (e) => {
            if(!isRunning) return;
            let car = cars.find(c => c.id === state.selected);
            let boost = car.power;
            if(speed > 5) boost *= 0.5;
            speed += boost;
            if(speed > 9) speed = 9;

            ui.wrap.style.transform = "scale(0.95)";
            setTimeout(() => ui.wrap.style.transform = "scale(1)", 80);
            tg.HapticFeedback.impactOccurred('light');
            
            if(e) {
                let el = document.createElement('div');
                el.className = 'pop-text';
                el.innerText = Math.floor(speed*10);
                el.style.left = e.clientX + 'px';
                el.style.top = e.clientY + 'px';
                document.body.appendChild(el);
                setTimeout(()=>el.remove(), 600);
            }
        };

        const finish = () => {
            clearInterval(loop);
            isRunning = false;
            ui.clientBubble.classList.remove('visible');
            ui.trip.style.width = '0%';
            ui.speed.innerText = '0';
            
            let car = cars.find(c => c.id === state.selected);
            let reward = car.reward + currentClient.tip;
            state.money += reward;
            
            // Level Logic
            state.xp += 25;
            let nextXp = state.level * 100;
            
            if(state.xp >= nextXp) {
                state.xp -= nextXp;
                state.level++;
                state.fuel = state.maxFuel;
                showLevelUpModal();
            } else {
                tg.HapticFeedback.notificationOccurred('success');
            }

            save(); render();
        };

        // LEVEL UP SYSTEM
        function showLevelUpModal() {
            document.getElementById('modal-lvl').innerText = state.level;
            let modal = document.getElementById('modal-overlay');
            modal.style.display = 'flex';
            
            // Animation trick
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('.modal-card').style.transform = 'scale(1)';
            }, 10);

            fireConfetti();
            tg.HapticFeedback.notificationOccurred('success');
        }

        function closeModal() {
            let modal = document.getElementById('modal-overlay');
            modal.style.opacity = '0';
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function fireConfetti() {
            for(let i=0; i<30; i++) {
                let c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + '%';
                c.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                c.style.animationDuration = (Math.random()*2+2)+'s';
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 4000);
            }
        }

        // SHOP & NAV
        const renderShop = () => {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            cars.forEach(c => {
                let isOwned = state.owned.includes(c.id);
                let btn = isOwned 
                    ? `<button class="btn-buy" onclick="pick(${c.id})">–í–ó–Ø–¢–¨</button>`
                    : `<button class="btn-buy" onclick="buy(${c.id})">${c.price}üí∞</button>`;
                
                if(state.selected === c.id) btn = `<button class="btn-buy" style="background:var(--text-main);color:white">–í–´–ë–†–ê–ù–û</button>`;

                let div = document.createElement('div');
                div.className = 'shop-card';
                div.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="font-size:32px">${c.emoji}</div>
                        <div><div style="font-weight:700">${c.name}</div><div style="font-size:12px;color:#6B7280">+${c.reward}</div></div>
                    </div>${btn}`;
                list.appendChild(div);
            });
        };

        window.buy = (id) => {
            let c = cars.find(x => x.id === id);
            if(state.money >= c.price) {
                state.money -= c.price;
                state.owned.push(id);
                state.selected = id;
                save(); render(); renderShop();
            }
        };
        window.pick = (id) => { state.selected = id; save(); render(); renderShop(); };

        window.setTab = (t) => {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if(t === 'game') {
                document.getElementById('shop-layer').style.display = 'none';
                document.querySelectorAll('.nav-item')[0].classList.add('active');
            } else {
                renderShop();
                document.getElementById('shop-layer').style.display = 'block';
                document.querySelectorAll('.nav-item')[1].classList.add('active');
            }
        };

        setInterval(() => {
            if(state.fuel < state.maxFuel && (Date.now()-state.lastRefill >= 60000)) {
                state.fuel++; state.lastRefill = Date.now(); save(); render();
            }
        }, 1000);

        load(); render();

    </script>
</body>
</html>